!function(u){u.su.moduleManager.define("networkMap",{services:["moduleLoader","ajax","device","timer","moduleManager"],models:["statusAll","internetSpeedModel","onlineUpgradeModel","portModel"],stores:["connectedClientsStore","upgradeOperationStore","oneMeshClientsStore"],deps:["mapInternet","navigatorController"],views:["networkMapView"],listeners:{"ev_on_launch":function(e,t,n,a,o,r,s){t.loadModules(function(){t.switchModule("internet"),t.startGetDeviceNum()}),!0===s.device.getConfig().supportSelectPort&&a.portModel.load(),t.startGetInternetStatus(),u("#printer-item").addClass("hidden"),s.device.getIsTriband()?u("#wireless-5g-2-item").removeClass("hidden"):(u("#wireless-5g-2-item").addClass("hidden"),u("#wireless-5g-item .text").text(u.su.CHAR.NETWORK_MAP.G5));var i=u.su.CHAR.UPGRADE.NOTICE;n.networkMapView.upgradeMsg3.setContent(i),setTimeout(function(){t.isRunning()&&(s.device.getConfig().supportAutoUpdate?s.ajax.request({proxy:"autoUpgradeReadProxy",method:"read",success:function(e){var t=s.moduleManager.get("index");t&&t.hideSupportTips(),n.networkMapView.autoUpdateMsg.show()},fail:t.updateHandler}):t.updateHandler())},1889),u("#map-clients .map-clients-icon-num").hide(),u("#map-mesh .map-clients-icon-num").hide()},"ev_before_destroy":function(e,t){t.beforeDestroy()},"ev_clients_number_changed":function(e,t){this.setClientsNumber(t)},"ev_mesh_number_changed":function(e,t){this.setMeshNumber(t)}},init:function(a,o,r,t,n,s){this.configViews({}),this.control({"#map-internet":{"click":function(e){a.switchModule("internet")}},"#map-router":{"click":function(e){a.switchModule("router")}},"#map-clients":{"click":function(e){a.switchModule("clients"),setTimeout(function(){t.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){a.setClientsNumber(t.connectedClientsStore.getData().length)}})},11)}},"#map-mesh":{"click":function(e){a.switchModule("mesh"),setTimeout(function(){t.oneMeshClientsStore.load({data:{operation:"read"},success:function(e){a.setMeshNumber(t.oneMeshClientsStore.getData().length),u.su.moduleManager.get("mapMesh").checkLength(t.oneMeshClientsStore.getData().length)}})},11)}},"#upgrade-msg-2":{"ev_msg_ok":function(){a.startOnlineUpgrade()}},"#upgrade-msg-3":{"ev_msg_ok":function(){a.startOnlineUpgrade()},"ev_msg_close":function(){s.ajax.request({method:"write",proxy:"upgradeReadProxy",data:{"remind_later":"1"}})},"click":function(e){u(e.target).hasClass("upgrade-text")&&(o.networkMapView.upgradeMsg3.close(),setTimeout(function(){n.navigatorController.goTo("firmware")},20))}},"#upgrade-msg-4":{"ev_msg_close":function(){s.ajax.request({method:"write",proxy:"upgradeReadProxy",data:{"remind_later":"1"}})},"click":function(e){u(e.target).hasClass("upgrade-text")&&(o.networkMapView.upgradeMsg4.close(),setTimeout(function(){n.navigatorController.goTo("firmware")},20))}},"#upgrade-now-button":{"ev_button_click":function(){o.networkMapView.upgradeMsg4.close(),a.startOnlineUpgrade()}},"#auto-update-now-btn":{"ev_button_click":function(){n.navigatorController.goTo("firmware")}},"#auto-update-later-btn":{"ev_button_click":function(){o.networkMapView.autoUpdateMsg.close()}}}),this.listen({"views.networkMapView.updateOperation":{"ev_value_change":function(e,t){o.networkMapView.upgradeMsg4.close(),s.ajax.request({method:"write",proxy:"upgradeReadProxy",data:{"remind_later":"remind"==t?"1":"0"}})}},"models.onlineUpgradeModel":{"ev_loaded":function(){var e=r.onlineUpgradeModel.detail.getValue(),t="";if(e)t=e.replace(/\\\\/g,"&#92;").replace(/\\n/g,"<br>");else{var n=s.device.getProductName()||u.su.CHAR.NETWORK_MAP.ROUTER;t=u.su.CHAR.UPGRADE.NOTICE_IMPORTANT.replace("%model%",a.modelName||n)}o.networkMapView.updateDetails.setText(t),u.su.scrollbar({ele:"#upgrade-msg-2 .advanced-panel .panel-content"})}}})}},function(a,r,o,t,n,s){var i,d=null,l=null,e=null;return{delayInterval:0,modelName:"",startOnlineUpgrade:function(){var e=u.su.moduleManager.get("firmware");e.setMode("networkMap"),e.startOnlineUpgrade()},loadModules:function(e){var t=u.Deferred(),n=u.Deferred(),a=u.Deferred(),o=u.Deferred();s.moduleLoader.load({module:"networkMap"},{module:"mapInternet"},r.networkMapView.mapInternetLoader,function(){t.resolve()}),s.moduleLoader.load({module:"networkMap"},{module:"mapRouter"},r.networkMapView.mapRouterLoader,function(){n.resolve()}),1==s.device.getConfig().supportOneMesh&&"router"==s.device.getCurrentMode()?s.moduleLoader.load({module:"networkMap"},{module:"mapMesh"},r.networkMapView.mapMeshLoader,function(){o.resolve()}):(u("#map-mesh").hide(),u(".map-line.mesh").hide(),o.resolve()),s.moduleLoader.load({module:"networkMap"},{module:"mapClients"},r.networkMapView.mapClientsLoader,function(){a.resolve()}),r.networkMapView.mapInternetLoader.hide(),r.networkMapView.mapRouterLoader.hide(),r.networkMapView.mapMeshLoader.hide(),r.networkMapView.mapClientsLoader.hide(),u.when(t,n,o,a).then(function(){e&&e()})},switchModule:function(e){for(var t=["internet","router","mesh","clients"],n=0;n<t.length;n++){var a="map"+(t[n].charAt(0).toUpperCase()+t[n].slice(1))+"Loader",o="#map-"+t[n];t[n]===e?(u(o).addClass("active"),r.networkMapView[a].show()):(u(o).removeClass("active"),r.networkMapView[a].hide())}i=e},getCurrentModule:function(){return i},startGetInternetStatus:function(){var e=s.device.getConfig().supportSpeedTest;e&&a.setInternetSpeed({upSpeed:0,downSpeed:0}),clearInterval(d);var t={success:function(e){n.mapInternet.setInternetStatus(e),"CONNECTED"===e.internetStatus.toUpperCase()?u("#map-internet .map-internet-icon-status").removeClass("disconnected poorconnected warning"):"POOR_CONNECTED"===e.internetStatus.toUpperCase()?u("#map-internet .map-internet-icon-status").addClass("poorconnected"):u("#map-internet .map-internet-icon-status").addClass("disconnected")}};if(d=setInterval(function(){a.getInternetStatus(t)},3e3),a.getInternetStatus(t),"router"!==s.device.getCurrentMode()||!e)return r.networkMapView.speedDownload.hide(),void r.networkMapView.speedUpload.hide();a.startGetInternetSpeed(),r.networkMapView.speedDownload.show(),r.networkMapView.speedUpload.show()},getInternetStatus:function(e){if(e)var t=e.success,n=e.fail;s.ajax.request({proxy:"internetStatusProxy",success:function(e){t&&t(e)},fail:function(e){n&&n(e)}})},startGetInternetSpeed:function(){clearInterval(l);var e={success:function(e){a.setInternetSpeed(e)}};l=setInterval(function(){a.getInternetSpeed(e)},3229)},startGetDeviceNum:function(){e=s.timer.setInterval(a,function(){0==a.delayInterval&&"clients"!=a.getCurrentModule()&&t.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){a.setClientsNumber(t.connectedClientsStore.getData().length),a.delayInterval=0},fail:function(){a.delayInterval=0},error:function(){a.delayInterval=0}}),0==a.delayInterval&&"mesh"!=a.getCurrentModule()&&"router"==s.device.getCurrentMode()&&1==s.device.getConfig().supportOneMesh&&t.oneMeshClientsStore.load({data:{operation:"read"},success:function(e){a.setMeshNumber(t.oneMeshClientsStore.getData().length),a.delayInterval=0},fail:function(){a.delayInterval=0},error:function(){a.delayInterval=0}}),a.delayInterval=1},20123,!0)},getInternetSpeed:function(e){if(e)var t=e.success,n=e.fail;o.internetSpeedModel.load({success:function(){t&&t(o.internetSpeedModel.getData())},fail:function(e){n&&n(e)}})},setInternetSpeed:function(e){var t=a.separateSpeed(e.upSpeed),n=a.separateSpeed(e.downSpeed);r.networkMapView.speedDownload.setField("value",n.value),r.networkMapView.speedDownload.setField("unit",n.unit),r.networkMapView.speedUpload.setField("value",t.value),r.networkMapView.speedUpload.setField("unit",t.unit)},setProductName:function(e){a.modelName=e;var t=s.device.getProductName()||u.su.CHAR.NETWORK_MAP.ROUTER;r.networkMapView.mapRouter.setField("productName",e||t),r.networkMapView.updateNotice.setText(u.su.CHAR.UPGRADE.NOTICE_IMPORTANT.replace("%model%",e||t))},handleWirelessIcon:function(e,t){if(t)"on"===e?u("#wireless-"+t+"-item").removeClass("disabled"):u("#wireless-"+t+"-item").addClass("disabled");else{var n=e.wireless2gEnable,a=e.wireless5gEnable,o=e.wireless5g2Enable;"on"===n?u("#wireless-2g-item").removeClass("disabled"):u("#wireless-2g-item").addClass("disabled"),"on"===a?u("#wireless-5g-item").removeClass("disabled"):u("#wireless-5g-item").addClass("disabled"),"on"===o?u("#wireless-5g-2-item").removeClass("disabled"):u("#wireless-5g-2-item").addClass("disabled")}},handlePrinterIcon:function(e){var t=e.printerCount;0===parseInt(t,10)?u("#printer-item").addClass("hidden"):u("#printer-item").removeClass("hidden")},setClientsNumber:function(e){(e=parseInt(e,10))&&2<e.toString().length?u("#map-clients .map-clients-icon-num").addClass("huge-num"):u("#map-clients .map-clients-icon-num").removeClass("huge-num"),u("#map-clients .map-clients-icon-num").text(isNaN(e)?0:e).show()},setMeshNumber:function(e){(e=parseInt(e,10))&&2<e.toString().length?u("#map-mesh .map-clients-icon-num").addClass("huge-num"):u("#map-mesh .map-clients-icon-num").removeClass("huge-num"),u("#map-mesh .map-clients-icon-num").text(isNaN(e)?0:e).show()},separateSpeed:function(e){var t={},n=e;return t.unit=n/1024<1?(t.value=0===n?0:n/1024,u.su.CHAR.NETWORK_MAP.KBPS):n/1024/1024<1?(t.value=n/1024,u.su.CHAR.NETWORK_MAP.KBPS):(t.value=n/1024/1024,u.su.CHAR.NETWORK_MAP.MBPS),t.value=parseFloat(t.value.toFixed(2)),t},beforeDestroy:function(){clearInterval(d),clearInterval(l),clearInterval(e)},updateHandler:function(){s.moduleLoader.load({module:"networkMap"},{module:"firmware"},r.networkMapView.upgradeLoader,function(){r.networkMapView.upgradeLoader.hide(),sessionStorage&&sessionStorage.getItem&&localStorage.getItem("token")!=sessionStorage.getItem("upgradeToken")&&s.ajax.request({proxy:"upgradeReadProxy",method:"read",success:function(e){"1"==e.remind_now&&(1==e.type?(r.networkMapView.upgradeMsg4.show(),sessionStorage.setItem("upgradeToken",localStorage.getItem("token"))):2==e.type?(r.networkMapView.upgradeMsg3.show(),sessionStorage.setItem("upgradeToken",localStorage.getItem("token"))):3==e.type&&r.networkMapView.upgradeMsg2.show()),"1"==localStorage.getItem("upgradeSuccess")&&(r.networkMapView.networkUpgradeSuccessMsg.show(),localStorage.setItem("upgradeSuccess",0))}})})}}})}(jQuery);
!function(h){h.su.moduleManager.define("dashboard",{deps:["speedTest","navigatorController","main"],services:["ajax","timer","moduleLoader","moduleManager"],models:["statusAll","internetSpeedModel","priorityEnable"],stores:["connectedClientsStore","usbStorageStore","timePeriodStore"],views:["dashboardView"],listeners:{"ev_on_launch":function(e,t,n,a,i,o,s){this.unRegisterAutoSaveData([i.connectedClientsStore]),t.initPerformance(),t.initSpeedtest(),t.initClients(),s.timer.setInterval(t,function(){a.statusAll.load()},2e3,!0),a.priorityEnable.getOnOff()}},init:function(o,e,s,r,l,d){this.configViews({id:"dashboardView",items:[{id:"internet-conn-note",title:h.su.CHAR.NETWORK_MAP.TRY_FOLLOW,items:[{text:h.su.CHAR.NETWORK_MAP.TRY_1},{text:h.su.CHAR.NETWORK_MAP.TRY_2},{text:h.su.CHAR.NETWORK_MAP.TRY_3},{text:h.su.CHAR.NETWORK_MAP.TRY_4}]},{id:"connected-clients-grid",configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty"},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){var n="",a="",i="";switch(e=e.toLowerCase()){case"pc":n="icon-pc";break;case"phone":n="icon-phone";break;case"pad":n="icon-pad";break;case"other":n="icon-pc";break;default:n="icon-"+e}return t.isGaming&&(i='<span class="gaming-tag"></span>'),a+='<div class="device-type-container widget-container">',a+='<span class="icon '+n+' ">'+i+"</span>",null!=t.enableInternet&&(a+='<span class="text">'+(t.enableInternet?"":h.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),a+="</div>",a+='<div class="device-info-container widget-container">',a+='<div class="mac">'+t.mac+"</div>",a+='<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>",a+="</div>"}},{text:h.su.CHAR.DASHBOARD.TYPE,width:"16%",dataIndex:"deviceType",cls:"s-hide",renderer:function(e,t){var n="",a="",i="";switch(e=e.toLowerCase()){case"pc":n="icon-pc";break;case"phone":n="icon-phone";break;case"pad":n="icon-pad";break;case"other":n="icon-pc";break;default:n="icon-"+e}return t.isGaming&&(i='<span class="gaming-tag"></span>'),a+='<div class="device-type-container widget-container">',a+='<span class="icon '+n+' ">'+i+"</span>",null!=t.enableInternet&&(a+='<span class="text">'+(t.enableInternet?"":h.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),a+="</div>"}},{text:h.su.CHAR.DASHBOARD.INFORMATION,dataIndex:"deviceName",width:"25%",cls:"s-hide",renderer:function(e,t){var n="";if("object"===h.type(t)){var a=t.deviceName;n+='<div class="device-info-container widget-container">',n+='<div class="name" title="'+a+'">'+a+"</div>",n+='<div class="mac">'+t.mac+"</div>",n+='<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>",n+="</div>"}return n}},{text:h.su.CHAR.DASHBOARD.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,t){var n,a,i="",o=function(e){var t;return t=(e=parseInt(e,10))/1024<1?(0!==e&&(e=(e/1024).toFixed(2)),h.su.CHAR.DASHBOARD.KBPS):e/1024/1024<1?(e/1024<1e3?e=(e/1024).toFixed(1):e/=1024,h.su.CHAR.DASHBOARD.KBPS):(e=(e/1024/1024).toFixed(1),h.su.CHAR.DASHBOARD.MBPS),{speed:e,unit:t}};return"object"===h.type(t)&&(n=o(t.downloadSpeed),i+='<div class="speed-upload-container widget-container">',i+='<span class="icon"></span>',i+='<span class="text">'+(a=o(t.uploadSpeed)).speed+"</span>",i+='<span class="unit">'+a.unit+"</span>",i+="</div>",i+='<div class="speed-download-container widget-container">',i+='<span class="icon"></span>',i+='<span class="text">'+n.speed+"</span>",i+='<span class="unit">'+n.unit+"</span>",i+="</div>"),i}},{text:h.su.CHAR.DASHBOARD.DEVICE_PRIORITY,dataIndex:"enablePriority",xtype:"customWidget",cls:"status connected-clients-grid-priority-td",widgetName:"switch",settings:{trueValue:!0,falseValue:!1}},{text:h.su.CHAR.DASHBOARD.TIMING,dataIndex:"timePeriod",xtype:"customWidget",width:90,cls:"s-2-col",widgetName:"combobox",settings:{noneSelectedText:"",items:r.timePeriodStore.getData()},renderer:function(e,t){return!t.enablePriority&&"---"}}]}}]}),this.control({"#speed-test-mini-panel":{"click":function(){h("#speed-test-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),h("#internet-block").toggle(h("#speed-test-mini-panel").hasClass("selected")),h("#performance-panel").hide(),h("#usb-panel").hide(),e.dashboardView.internetSpeedUsage.resize()}},"#performance-mini-panel":{"click":function(){h("#performance-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),h("#internet-block").hide(),h("#performance-panel").toggle(h("#performance-mini-panel").hasClass("selected")),h("#usb-panel").hide(),e.dashboardView.cpuLoad.resize(),e.dashboardView.memoryUsage.resize()}},"#usb-mini-panel":{"click":function(){r.usbStorageStore.getData()&&r.usbStorageStore.getData().length&&(h("#usb-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),h("#internet-block").hide(),h("#performance-panel").hide(),h("#usb-panel").toggle(h("#usb-mini-panel").hasClass("selected")))}},"#map-router-usb-button":{"ev_button_click":function(e){l.navigatorController.goTo("storageSharing")}}}),this.listen({"models.statusAll":{"ev_loaded":function(e,t){o.setStorage(t),o.setPerformance(t)}},"stores.connectedClientsStore":{"ev_data_change":function(e,t,n){if("enablePriority"===n.getName()&&t.value!==t.oldValue){var a=function(){i()&&(r.connectedClientsStore.abort(),r.connectedClientsStore.sync({success:function(e){r.connectedClientsStore.loadData(e,!0)}}))},i=function(){var e=d.moduleManager.get("bandwidth");return!!e.hasConfigured()||(t.value&&(o.stopGetClients(),e.showBandwithMsg()),!1)};"off"==s.priorityEnable.enable.getValue()&&t.value?l.main.confirm(h.su.CHAR.QOS.GAMING_DASHBOARD_NOTICE,function(){i()&&(s.priorityEnable.enable.setValue("on"),s.priorityEnable.setOnOff({success:function(){a(),s.priorityEnable.getOnOff()}}))},function(){r.connectedClientsStore.abort(),r.connectedClientsStore.load({data:{operation:"loadDevice"}})},h.su.CHAR.OPERATION.CONTINUE):a()}"timePeriod"==n.getName()&&t.value!=t.oldValue&&(r.connectedClientsStore.abort(),r.connectedClientsStore.sync())}}})}},function(c,u,a,n,e,i){var o,s=null,p=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),S=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),r=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),l=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),b=function(e,t){e=e||2e3,t=t||7;for(var n=new Date,a=[];t--;)a.unshift(i(n)),n=new Date(n-e);function i(e){var t="";return t+=("0"+e.getHours()).slice(-2),t+=":",t+=("0"+e.getMinutes()).slice(-2),t+=":",t+=("0"+e.getSeconds()).slice(-2)}return a};return{speedRequestInterval:2e3,setStorage:function(e){var i={PB:h.su.CHAR.UNIT.PB,TB:h.su.CHAR.UNIT.TB,GB:h.su.CHAR.UNIT.GB,MB:h.su.CHAR.UNIT.MB,KB:h.su.CHAR.UNIT.KB,B:h.su.CHAR.UNIT.B};function o(e){return e&&e.toUpperCase()}e.usbStorages.length?(u.dashboardView.noUSBTips.hide(),u.dashboardView.USBFieldset.show(),h.each(e.usbStorages,function(e,t){var n=h.su.capacityToNum(t.available+i[o(t.availableUnit)]),a=h.su.capacityToNum(t.capacity+i[o(t.capacityUnit)]);t.usageRate=n/a*100}),h("#usb-panel").toggleClass("single-column",1===e.usbStorages.length),n.usbStorageStore.loadData(e.usbStorages,!0)):(u.dashboardView.noUSBTips.show(),u.dashboardView.USBFieldset.hide(),h("#usb-mini-panel").removeClass("selected"),h("#usb-panel").hide())},initSpeedtest:function(){u.dashboardView.internetSpeedUsage.setOption(c.calculateInternetSpeedOption()),u.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",h.su.CHAR.DASHBOARD.KBPS),u.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",h.su.CHAR.DASHBOARD.KBPS),u.dashboardView.internetSpeedUpload.setValue("0 "+h.su.CHAR.DASHBOARD.KBPS),u.dashboardView.internetSpeedDownload.setValue("0 "+h.su.CHAR.DASHBOARD.KBPS),i.timer.setInterval(c,function(){i.ajax.request({proxy:"internetStatusProxy",success:function(e){"CONNECTED"===e.internetStatus.toUpperCase()?(c.getInternetSpeed({success:function(e){c.setInternetSpeed(e)}}),u.dashboardView.speedTestPanel.show(),u.dashboardView.noInternetFieldset.hide()):(u.dashboardView.speedTestPanel.hide(),u.dashboardView.noInternetFieldset.show(),u.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",h.su.CHAR.DASHBOARD.KBPS),u.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",h.su.CHAR.DASHBOARD.KBPS))}})},c.speedRequestInterval,!0)},getInternetSpeed:function(e){if(e)var t=e.success,n=e.fail;a.internetSpeedModel.load({success:function(){t&&t(a.internetSpeedModel.getData())},fail:function(e){n&&n(e)}})},setInternetSpeed:function(e){var t=this.separateSpeed(e.upSpeed),n=this.separateSpeed(e.downSpeed);u.dashboardView.speedTestMiniPanel.setField("uploadSpeed",t.value),u.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",t.unit),u.dashboardView.speedTestMiniPanel.setField("downloadSpeed",n.value),u.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",n.unit),u.dashboardView.internetSpeedUpload.setValue(t.value+" "+t.unit),u.dashboardView.internetSpeedDownload.setValue(n.value+" "+n.unit);var a=b(c.speedRequestInterval,26);p.shift(),p.push(e.upSpeed/1024),S.shift(),S.push(e.downSpeed/1024);var i,o,s,r,l=Math.max.apply(this,p.concat(S));function d(e){var t,n,a,i=parseInt(e,10).toString().length,o=Math.max(i-2,0);return t=e,n=o,a=3*Math.pow(10,n),Math.ceil(t/a)*a}s=1024<=l?(l/=1024,i=h.map(p,function(e){return e/1024}),o=h.map(S,function(e){return e/1024}),r=h.su.CHAR.DASHBOARD.MBPS,d(l)):(i=p,o=S,r=h.su.CHAR.DASHBOARD.KBPS,Math.max(d(l),120)),u.dashboardView.internetSpeedUsage.setOption({xAxis:[{data:a}],yAxis:[{max:s,interval:s/3,axisLabel:{formatter:function(e,t){return s/3*t+r}}}],series:[{data:i},{data:o}]})},calculateInternetSpeedOption:function(e){return e=h.extend({title:"",color:"#ffcd08",name:"internetSpeed"},e),{title:{show:!1},grid:{top:10,right:30,left:72,bottom:40,containLabel:!1},xAxis:[{name:"",type:"category",axisLine:{show:!1},axisLabel:{show:!0,interval:4,margin:20,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12}},axisTick:{show:!1,alignWithLabel:!0},splitLine:{show:!0,interval:4,lineStyle:{color:"#4a3a3a"}},boundaryGap:!1,data:b(c.speedRequestInterval,26)}],yAxis:[{max:120,min:0,interval:40,offset:40,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{color:"#4a3a3a"}},axisLabel:{show:!0,align:"left",margin:24,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+h.su.CHAR.DASHBOARD.KBPS}}}],series:[{name:"upload",type:"line",smooth:!0,symbol:"none",zIndex:2,itemStyle:{normal:{color:"rgb(236,154,0)",borderColor:"rgb(236,154,0)"}},areaStyle:{normal:{color:"rgba(236,154,0,0.4)"}},lineStyle:{width:1},data:e.data},{name:"download",type:"line",smooth:!0,symbol:"none",zIndex:1,itemStyle:{normal:{color:"rgb(175,0,0)",borderColor:"rgb(175,0,0)"}},areaStyle:{normal:{color:"rgba(175,0,0,0.4)"}},lineStyle:{width:1},data:e.data}]}},initPerformance:function(){u.dashboardView.cpuLoad.setOption(c.calculateLineOption({title:h.su.CHAR.DASHBOARD.CPU_LOAD,color:"#ffcd08",tooltip:{backgroundColor:"rgba(236,154,0,0.4)"},areaColor:"rgba(255, 205, 8, 0.5)",name:h.su.CHAR.DASHBOARD.CPU_CORE_NUMBER+":"})),u.dashboardView.memoryUsage.setOption(c.calculateLineOption({title:h.su.CHAR.DASHBOARD.MEMORY_USAGE,color:"#ff0000",tooltip:{backgroundColor:"rgba(255, 0, 0, 0.8)"},areaColor:"rgba(175,0,0,0.4)"}))},setPerformance:function(e){var t=e.cpuUsage,n=e.memUsage,a=b(2e3,7);r.shift(),r.push(t),u.dashboardView.cpuLoad.setOption({xAxis:[{data:a}],series:{data:r}}),l.shift(),l.push(n),u.dashboardView.memoryUsage.setOption({xAxis:[{data:a}],series:{data:l}})},calculateLineOption:function(s){return{title:{show:!1,text:(s=h.extend({title:"",color:"#ffcd08",name:"",areaColor:"rgba(255, 205, 8, 0.5)"},s)).title,textStyle:{fontSize:13},left:20},grid:{top:10,right:0,left:40,bottom:10},tooltip:h.extend({show:!0,formatter:"{c}%",textStyle:{color:"#fff",fontSize:12,lineHeight:14,fontFamily:"Arial, Sans-Serif, Geneva, Verdana"},padding:[2.6,6],position:function(e,t,n,a,i){var o="";return o+="<span>"+t.value+"%</span>",o+='<span style="display:block;position:absolute;left:'+(i.contentSize[0]/2-3+"px")+";bottom:-6px;border-top:6px solid "+s.tooltip.backgroundColor+';border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:none;background-color:transparent;width:0;height:0;line-height:14px;"></span>',h(n).html(o),[e[0]-18.5,e[1]-40]}},s.tooltip),xAxis:[{name:"",nameLocation:"middle",nameTextStyle:{color:"#000"},type:"category",axisLine:{show:!1},axisLabel:{show:!1},axisTick:{show:!1},boundaryGap:!1,data:b(2e3,7)}],yAxis:[{max:100,min:0,interval:20,offset:32,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1,lineStyle:{type:"dashed"}},axisLabel:{show:!0,align:"left",textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+"%"}}}],series:[{name:"RX",type:"line",smooth:!0,symbol:"emptyCircle",symbolSize:6,showAllSymbol:!0,legendHoverLink:!1,itemStyle:{normal:{color:s.color,borderColor:s.color}},areaStyle:{normal:{color:s.areaColor}},lineStyle:{width:1},data:s.data}]}},initClients:function(){i.moduleLoader.load({module:"dashboard"},{module:"bandwidth"},u.dashboardView.qosBandwidthLoader,function(){var e=i.moduleManager.get("bandwidth");e.on("ev_qos_saved",function(e){n.connectedClientsStore.abort(),a.priorityEnable.enable.setValue("on"),a.priorityEnable.enable.record(),a.priorityEnable.setOnOff({preventSuccessEvent:!0}),n.connectedClientsStore.sync({success:function(e){n.connectedClientsStore.loadData(e,!0),t()}})}),e.on("ev_qos_save_close",function(e){n.connectedClientsStore.reset(),t()}),e.on("ev_qos_save_cancel",function(e){n.connectedClientsStore.reset(),t()})});var t=function(){clearInterval(s),s=setInterval(function(){n.connectedClientsStore.load({data:{operation:"loadSpeed"}})},1e4)},e={data:{operation:"loadDevice"},success:function(e){n.connectedClientsStore.load({data:{operation:"loadSpeed"}})}};n.connectedClientsStore.load(e),t()},stopGetClients:function(){clearInterval(s)},getClients:function(){i.ajax.request({proxy:"clientStatusProxy",success:function(e){o=e,n.connectedClientsStore.load({data:{operation:"loadSpeed"}})}})},getAccessControlMode:function(e){var t;e&&(t=e.success),a.accessControl.load({success:function(e){t&&t(a.accessControl.getData())}})},blockDevice:function(e){i.ajax.request({proxy:"blockClientProxy",data:{mac:e},success:function(e){n.connectedClientsStore.load({operation:"loadDevice"})}})},beforeDestroy:function(){clearInterval(s)},getIPaddr:function(e){if(o)for(var t in o)for(var n=0,a=o[t].length;n<a;n++)if(o[t][n].macaddr==e)return o[t][n].ipaddr||"";return""},separateSpeed:function(e){var t={},n=e;return t.unit=n/1024<1?(t.value=0===n?0:n/1024,h.su.CHAR.DASHBOARD.KBPS):n/1024/1024<1?(t.value=n/1024,h.su.CHAR.DASHBOARD.KBPS):(t.value=n/1024/1024,h.su.CHAR.DASHBOARD.MBPS),t.value=parseFloat(t.value.toFixed(2)),t}}})}(jQuery);
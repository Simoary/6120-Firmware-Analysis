!function(g){g.su.moduleManager.define("cloud",{deps:[],services:["ajax","device"],models:[],stores:[],views:["cloudTPLinkIdView","cloudIframeView"],listeners:{"ev_on_launch":function(e,n,t,o,i,a,s){n=this;var r,u,l=this;g.su=g.su||{},g.su.Message=((r=function(e){this.id=e.id||parseInt(1e3*Math.random()*1e3*1e3,10),this.ack=e.ack||null,this.type=e.type,this.name=e.name,this.data=e.data}).prototype.getId=function(){return this.id},r.prototype.setAck=function(e){this.ack=e},r.prototype.getAck=function(){return this.ack},r.prototype.getType=function(){return this.type},r.prototype.getName=function(){return this.name},r.prototype.setData=function(e){this.data=e},r.prototype.getData=function(){return this.data},r),g.su.Request=((u=function(e){this.readyState=0,this.timeout=1e4,this.timeoutId=null,this.timeoutFlag=!1;var t=new g.su.Message(e);this.requestContent=t,this.responseContent=null,this.onload=null,this.onerror=null,this.ontimeout=null}).prototype.send=function(){var e=this,t=this.requestContent,n=JSON.stringify(t);e.timeoutFlag=!1,window.parent.postMessage(n,g.origin),e.timeoutId=setTimeout(function(){e.timeoutFlag=!0,e.ontimeout&&e.ontimeout()},e.timeout)},u.prototype.responseHandler=function(){var e=this.responseContent;clearInterval(this.timeoutId),this.timeoutFlag=!1,this.onload&&"function"==typeof this.onload&&this.onload(e)},u),g.su.RequestManager={requests:{},handler:{},addRequest:function(e){var t=e.requestContent.getId();this.requests[t]=e},removeRequest:function(e){var t=e.requestContent.getId();delete this.requests[t]},getRequestByAck:function(e){return this.requests[e]},addHandler:function(e,t){this.handler[e]=t},onMessage:function(){var c=this;g(window).on("message",function d(e){var t=e.originalEvent||e;if("string"!=typeof t.data)throw"Error! Data is not a string.";try{var n=g.parseJSON(t.data)}catch(t){throw"Error! String can not be parsed."}var o=new g.su.Message(n),i=o.getType(),a=o.getAck();if("message"==i){var s=o.getName();n=o.getData(),c.handler[s](n)}else if(a){var r=g.su.RequestManager.getRequestByAck(a);if(r.responseContent=o,r.timeoutFlag)return;r.responseHandler(),g.su.RequestManager.removeRequest(r)}else if(s=o.getName()){n.data=n.data||{},c.handler[s](n.data),n.ack=n.id;var u=JSON.stringify(n);window.frames["cloud-login"].postMessage(u,l.cloudOrigin)}})}},g.su.RequestManager.onMessage(),g.su.RequestManager.addHandler("load",function(e){e.locale=s.device.getLocale(),e.force=s.device.getForce(),e.model=s.device.getProductName(),e.cloudOrigin=n.cloudOrigin,e.token=n.token;var t=n.getDeviceInfo();g.extend(e,t),n.clearWaitingEvent()}),g.su.RequestManager.addHandler("ev_mouseWheel",function(e){}),g.su.RequestManager.addHandler("ev_mouseClick",function(e){}),n.getToken("devicePages&page=account"),this.control({"#cloud-iframe-widget":{"load":function(){console.log("load")}}})}},init:function(e,t,n,o,i,a){}},function(i,a,e,t,n,s){i=this;return{getToken:function(e,t,n){var o;if(o=!1===n?g.su.url("/login?form=get_token"):g.su.url("/admin/cloud_account?form=get_token"),!i.token||t){i.tokenRead(e,0,o)}else a.cloudIframeView.cloudIframe.setIframeSrc(e)},tokenRead:function(t,n,o){s.ajax.request({url:o,success:function(e){i.token=e.token,!i.token&&++n<3?i.tokenRead(t,n,o):i.token?(i.cloudOrigin=e.origin_url,a.cloudIframeView.cloudIframe.setCloudOrigin(e.origin_url),a.cloudIframeView.cloudIframe.setIframeSrc(t)):g(window).trigger("ev_watingTimeout")}})},postToken:function(){var e={};e.token=i.token,g.su.Cloud.send({type:"message",name:"ev_token",data:e})},getDeviceInfo:function(e){var t;if(i.deviceInfo=i.deviceInfo||{},i.deviceInfo.cloudUserName){var n={};return n=i.deviceInfo}return t=!1===e?g.su.url("/login?form=get_deviceInfo"):g.su.url("/admin/cloud_account?form=get_deviceInfo"),s.ajax.request({ajax:{async:!1},url:t,success:function(e){i.deviceInfo=e.data,n=i.deviceInfo}}),n},clearWaitingEvent:function(){}}})}(jQuery);
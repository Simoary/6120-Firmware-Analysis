!function(R){R.su.moduleManager.define("pptp",{services:["ajax","device"],stores:["pptpGridStore","accessStore","pptpEncryptionStore","wanStore","dhcpAddressList"],models:["pptpVpnModel","dhcpServer","openVpnModel","l2tpIpsecModel"],deps:["utils","main"],views:["pptpView"],listeners:{"ev_on_launch":function(e,t,p,n,r,o,d){n.pptpVpnModel.load(),r.pptpGridStore.load(),n.openVpnModel.load(),n.dhcpServer.load(),r.dhcpAddressList.load(),d.device.getConfig().supportL2tpIpsec&&n.l2tpIpsecModel.load()}},init:function(u,r,P,_,V,c){var o,d;this.configViews({id:"pptpView",items:[{id:"grid-pptp",configs:{minLines:0,popEditor:{addTitle:R.su.CHAR.VPN_SERVER_PPTP.ADD_ACCOUNT,editTitle:R.su.CHAR.VPN_SERVER_PPTP.EDIT_ACCOUNT,addBtnText:R.su.CHAR.OPERATION.ADD_UPPERCASE,editBtnText:R.su.CHAR.OPERATION.ADD_UPPERCASE,content:"#grid-pptp-popEditor",fields:[{name:"username"},{name:"password"}]},paging:{},columns:[{text:R.su.CHAR.VPN_SERVER_PPTP.USERNAME,dataIndex:"username"},{text:R.su.CHAR.VPN_SERVER_PPTP.PASSWORD,dataIndex:"password",cls:"password-td",xtype:"customWidget",widgetName:"password",settings:{labelField:null,readOnly:!0}},{xtype:"actioncolumn",text:R.su.CHAR.VPN_SERVER_PPTP.MODIFY,renderer:function(e,t){return'<span class="icon"></span>','<span class="text"></span>',"</a>",'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete">','<span class="icon"></span>','<span class="text"></span>',"</a>",'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit"><span class="icon"></span><span class="text"></span></a><a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'}}]}}]}),this.listen({"models.pptpVpnModel.enable":{"ev_value_change":function(e,t){"on"===t?r.pptpView.pptpFieldset.show():r.pptpView.pptpFieldset.hide()}},"models.pptpVpnModel":{"ev_loaded":function(e,t){d=t.enable},"ev_model_submit_complete":function(e,t,p){"success"==t&&(d=p.enable)}}}),this.control({".index-common-save-btn":{"ev_will_auto_save":function(e,t){var p,n=P.pptpVpnModel.fromIpAddr.getValue(),r=P.pptpVpnModel.toIpAddr.getValue(),o=P.dhcpServer.ipaddrStart.getValue(),d=(P.dhcpServer.ipaddrEnd.getValue(),_.dhcpAddressList.getData()),s=P.openVpnModel.subnet.getValue(),a=(P.openVpnModel.mask.getValue(),_.pptpGridStore.getData()),i=P.pptpVpnModel.enable.getValue();if(P.pptpVpnModel.fromIpAddr.setNormal(),P.pptpVpnModel.toIpAddr.setNormal(),!0!==u.validateIpRange())return t.preventDefault(),!1;if(R.su.ipToInt(n)>R.su.ipToInt(r))return P.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.IP_RANGE),t.preventDefault(),!1;if(10<=R.su.ipToInt(r)-R.su.ipToInt(n))return P.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.PORT_RANGE_OUT),t.preventDefault(),!1;if(V.utils.isSameNet(n,o,"255.255.255.0"))return P.pptpVpnModel.fromIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_DHCP),t.preventDefault(),!1;if(V.utils.isSameNet(r,o,"255.255.255.0"))return P.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_DHCP),t.preventDefault(),!1;for(var l=0;l<d.length;l++)if(R.su.ipToInt(d[l].ip)>=R.su.ipToInt(n)&&R.su.ipToInt(d[l].ip)<=R.su.ipToInt(r))return P.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_RESERVED),t.preventDefault(),!1;if(V.utils.isSameNet(n,s,"255.255.255.0"))return P.pptpVpnModel.fromIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_OPENVPN),t.preventDefault(),!1;if(V.utils.isSameNet(r,s,"255.255.255.0"))return P.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_OPENVPN),t.preventDefault(),!1;if(c.device.getConfig().supportL2tpIpsec){if(p=P.l2tpIpsecModel.fromIpAddr.getValue(),P.l2tpIpsecModel.toIpAddr.getValue(),V.utils.isSameNet(n,p,"255.255.255.0"))return P.pptpVpnModel.fromIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_L2TPVPN),t.preventDefault(),!1;if(V.utils.isSameNet(r,p,"255.255.255.0"))return P.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_L2TPVPN),t.preventDefault(),!1}return 0!=a.length||"on"!=i||(V.main.showNotice(R.su.CHAR.VPN_SERVER_PPTP.NO_ACCOUNT_TIP,1),t.preventDefault(),!1)}},"#ipaddr-start":{"ev_textbox_focus":function(){P.pptpVpnModel.fromIpAddr.setNormal(),P.pptpVpnModel.toIpAddr.setNormal()},"ev_textbox_blur":function(){u.validateIpRange()}},"#ipaddr-end":{"ev_textbox_focus":function(){P.pptpVpnModel.fromIpAddr.setNormal(),P.pptpVpnModel.toIpAddr.setNormal()},"ev_textbox_blur":function(){u.validateIpRange()}},"#grid-pptp":{"ev_grid_before_item_delete":function(e,t,p){var n=_.pptpGridStore.getData();o=p,t.preventDefault(),console.log(d),"on"==d&&1==n.length?r.pptpView.deleteAccountAlert.show():r.pptpView.deleteAccountConfirm.show()},"ev_grid_before_save":function(e,t){for(var p=_.pptpGridStore.getEditingModel(),n=_.pptpGridStore.getStoreData(),r=p.username.getValue(),o=p.key.getValue(),d=0;d<n.length;d++)if(r===n[d].username&&o!=n[d].key)return p.username.setError(R.su.CHAR.VPN_SERVER_PPTP.USERNAME_CONFLICT),t.preventDefault(),!1;return!0}},"#delete-account-confirm":{"ev_msg_ok":function(e){_.pptpGridStore.getData();_.pptpGridStore.removeDataByKey(o),_.pptpGridStore.sync()}}})}},function(e,t,p,n,r,o){return{validateIpRange:function(){var e=p.pptpVpnModel.fromIpAddr.getValue(),t=p.pptpVpnModel.toIpAddr.getValue();return R.su.ipToInt(e)>R.su.ipToInt(t)?(p.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.IP_RANGE),R.su.CHAR.VPN_SERVER_PPTP.IP_RANGE):!(10<=R.su.ipToInt(t)-R.su.ipToInt(e))||(p.pptpVpnModel.toIpAddr.setError(R.su.CHAR.VPN_SERVER_PPTP.PORT_RANGE_OUT),R.su.CHAR.VPN_SERVER_PPTP.PORT_RANGE_OUT)}}})}(jQuery);
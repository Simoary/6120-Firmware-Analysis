!function(o){o.su.moduleManager.define("mapClients",{services:["ajax","timer","device","vtype"],deps:["networkMap","navigatorController"],models:["statusAll","accessControl","accessControlEnableM"],stores:["connectedClientsStore","blacklistOnlineStore"],views:["mapClientsView"],listeners:{"ev_on_launch":function(e,n,t,a,s,i,c){this.unRegisterAutoSaveData([s.connectedClientsStore,s.blacklistOnlineStore]),n.getClients(),"router"==c.device.getCurrentMode()?n.getAccessControlMode({success:function(e){"black"===e.accessMode?t.mapClientsView.mapClientsAccessControlBtn.setText(o.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST):t.mapClientsView.mapClientsAccessControlBtn.setText(o.su.CHAR.NETWORK_MAP.VIEW_WHITELIST),t.mapClientsView.blockConfirmMsg.setContent(o.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST)}}):(t.mapClientsView.mapClientsAccessControlBtn.hide(),s.connectedClientsStore.hideColumn("downloadSpeed"),s.connectedClientsStore.hideColumn("block"),s.connectedClientsStore.hideColumn("action-column"))},"ev_before_destroy":function(e,n){n.beforeDestroy()}},init:function(a,s,e,l,n,i){this.configViews({id:"mapClientsView",items:[{id:"connected-clients-grid",configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,n){var t="<div>"+e;return t+='<div class="phone edit" deviceName="'+n.deviceName+'" mac="'+n.mac+'"></div></div>'}},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,n){var t="",a="";switch(e=e.toLowerCase()){case"pc":t="icon-pc";break;case"phone":t="icon-phone";break;case"pad":t="icon-pad";break;case"other":t="icon-pc";break;default:t="icon-"+e}return a+='<div class="device-type-container widget-container">',a+='<span class="icon '+t+' "></span>',null!=n.enableInternet&&(a+='<span class="text">'+(n.enableInternet?"":o.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),a+="</div>",a+='<div class="device-info-container widget-container">',a+='<div class="mac">'+n.mac+"</div>",a+='<div class="ip">'+("0.0.0.0"==n.ip?"":n.ip)+"</div>",a+="</div>"}},{text:o.su.CHAR.NETWORK_MAP.TYPE,width:"10%",dataIndex:"deviceType",cls:"s-hide",renderer:function(e,n){var t="",a="";switch(e=e.toLowerCase()){case"pc":t="icon-pc";break;case"phone":t="icon-phone";break;case"pad":t="icon-pad";break;case"other":t="icon-pc";break;default:t="icon-"+e}return a+='<div class="device-type-container widget-container">',a+='<span class="icon '+t+' "></span>',null!=n.enableInternet&&(a+='<span class="text">'+(n.enableInternet?"":o.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),a+="</div>"}},{text:o.su.CHAR.NETWORK_MAP.INFORMATION,dataIndex:"deviceName",cls:"s-hide",renderer:function(e,n){var t="";if("object"===o.type(n)){var a=n.deviceName,s=n.mac;t+='<div class="device-info-container widget-container">',t+='<div class="name" title="'+a+'">'+a+"</div>",t+='<div class="mac">'+s+"</div>",t+='<div class="ip">'+("0.0.0.0"==n.ip?"":n.ip)+"</div>",t+='<div class="edit" deviceName="'+a+'" mac="'+s+'"></div>',t+="</div>"}return t}},{text:o.su.CHAR.NETWORK_MAP.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,n){var t,a,s="",i=function(e){var n;return n=(e=parseInt(e,10))/1024<1?(0!==e&&(e=(e/1024).toFixed(2)),o.su.CHAR.NETWORK_MAP.KBPS):e/1024/1024<1?(e/1024<1e3?e=(e/1024).toFixed(1):e/=1024,o.su.CHAR.NETWORK_MAP.KBPS):(e=(e/1024/1024).toFixed(1),o.su.CHAR.NETWORK_MAP.MBPS),{speed:e,unit:n}};return"object"===o.type(n)&&(t=i(n.downloadSpeed),s+='<div class="speed-upload-container widget-container">',s+='<span class="icon"></span>',s+='<span class="text">'+(a=i(n.uploadSpeed)).speed+"</span>",s+='<span class="unit">'+a.unit+"</span>",s+="</div>",s+='<div class="speed-download-container widget-container">',s+='<span class="icon"></span>',s+='<span class="text">'+t.speed+"</span>",s+='<span class="unit">'+t.unit+"</span>",s+="</div>"),s}},{text:o.su.CHAR.NETWORK_MAP.INTERFACE,dataIndex:"deviceTag",width:"15%",cls:"center-td s-2-col",renderer:function(e,n){var t=n.deviceTag,a="",s="";n.mac;switch(t){case"2.4G":case"2.4G_guest":a="<span class='icon icon-wireless signal-"+n.signal+"'></span><span class='text text-2g'>"+o.su.CHAR.NETWORK_MAP.G24+"</span>";break;case"5G":case"5G_guest":a=i.device.getIsTriband()?"<span class='icon icon-wireless signal-"+n.signal+"'></span><span class='text text-5g-1'>"+o.su.CHAR.NETWORK_MAP.G5_1+"</span>":"<span class='icon icon-wireless signal-"+n.signal+"'></span><span class='text text-5g'>"+o.su.CHAR.NETWORK_MAP.G5_1+"</span>";break;case"5G_1":case"5G_1_guest":a="<span class='icon icon-wireless signal-"+n.signal+"'></span><span class='text text-5g-1'>"+o.su.CHAR.NETWORK_MAP.G5_1+"</span>";break;case"5G_2":case"5G_2_guest":a="<span class='icon icon-wireless signal-"+n.signal+"'></span><span class='text text-5g-2'>"+o.su.CHAR.NETWORK_MAP.G5_2+"</span>";break;case"wired":a="<span class='icon icon-interface'></span>";break;case"offline":return a=o.su.CHAR.NETWORK_MAP.OFFLINE;case"unknown":return a="--";default:return a=o.su.CHAR.NETWORK_MAP.OFFLINE}return s+='<div class="interface-container widget-container">',s+=a,s+="</div>"}},{text:o.su.CHAR.NETWORK_MAP.TXRX,dataIndex:"txrate",cls:"center-td",width:"15%",renderer:function(e,n){return"wired"!==n.deviceTag&&"offline"!==n.deviceTag&&null!=e?-1<e.indexOf("-")&&-1<n.rxrate.indexOf("-")?"- -":e+" / "+n.rxrate:"- -"}},{text:o.su.CHAR.NETWORK_MAP.DURATION,dataIndex:"remainTime",width:"15%",cls:"s-last-td center-td",renderer:function(e,n){var t,a,s,i=n.duration,c="";return c+='<div class="duration-container widget-container">',t=parseInt(i/86400,10),a=parseInt(i%86400/3600,10),s=parseInt(i%3600/60,10),1===t?c=c+t+" "+o.su.CHAR.NETWORK_MAP.DAY+" ":1<t&&(c=c+t+" "+o.su.CHAR.NETWORK_MAP.DAYS+" "),0<a&&(c=c+a+" "+o.su.CHAR.NETWORK_MAP.H+" "),c=c+s+" "+o.su.CHAR.NETWORK_MAP.MIN,c+="</div>"}},{text:o.su.CHAR.NETWORK_MAP.BLOCK,xtype:"actioncolumn",dataIndex:"block",renderer:function(e,n){for(var t=l.blacklistOnlineStore.getData(),a="",s=0,i=t.length;s<i;s++)t[s].mac==n.mac&&(a="HOST"==t[s].host?"disabled":"");var c="";return c+='<a href="javascript:void(0)" class="grid-content-btn btn-block '+a+'">',c+='<span class="icon"></span>',c+='<span class="text"></span>',c+="</a>"}}]}}]}),this.control({"#connected-clients-grid => .btn-block":{"ev_grid_action_click":function(e,n){if(!(-1<e.target.className.indexOf("disable"))){var t=l.connectedClientsStore.getModelByKey(n);a.blockData={key:t.key.getValue(),deviceType:t.deviceType.getValue(),name:t.deviceName.getValue(),mac:t.mac.getValue(),ipaddr:t.ip.getValue(),conn_type:"wireless",host:"NOT HOST"},s.mapClientsView.blockConfirmMsg.show()}}},"#connected-clients-grid => .edit":{"click":function(e,n){s.mapClientsView.clientNameMsg.show(),s.mapClientsView.clientNameModelAlias.setValue(o(e.currentTarget).attr("deviceName")),s.mapClientsView.clientNameModelMac.setValue(o(e.currentTarget).attr("mac"))}},"#client-name-msg":{"ev_msg_ok":function(e,n){if(!0===a.checkDeviceName(s.mapClientsView.clientNameModelAlias.getValue()))i.ajax.request({data:{operation:"write",mac:s.mapClientsView.clientNameModelMac.getValue(),alias:s.mapClientsView.clientNameModelAlias.getValue()},proxy:"changeDeviceNameProxy",success:function(e){o.each(l.connectedClientsStore.getData(),function(e,n){n.mac==s.mapClientsView.clientNameModelMac.getValue()&&(o("[data-key="+n.key+"] .device-info-container .name").text(s.mapClientsView.clientNameModelAlias.getValue()),o("#connected-clients-grid_tr_"+n.key+"_td_1 .content div").html(s.mapClientsView.clientNameModelAlias.getValue()+'<div class="phone edit" devicename="'+s.mapClientsView.clientNameModelAlias.getValue()+'" mac="'+s.mapClientsView.clientNameModelMac.getValue()+'"></div>'))})}}),s.mapClientsView.clientNameMsg.hide();else{var t=o.su.CHAR.VTYPETEXT.DEVICE_NAME_INVALID;(s.mapClientsView.clientNameModelAlias.getValue().length<1||64<s.mapClientsView.clientNameModelAlias.getValue().length)&&(t=o.su.CHAR.VTYPETEXT.LEN_MIN_MAX.replace("%min",1).replace("%max",64)),s.mapClientsView.clientNameModelAlias.setError(t)}n.preventDefault()},"ev_msg_cancel":function(e,n){}},"#map-clients-access-control-btn":{"ev_button_click":function(e){n.navigatorController.goTo("accessControl")}},"#block-confirm-msg":{"ev_msg_ok":function(e){a.blockDevice(a.blockData)}}}),this.listen({})}},function(a,t,s,i,c,l){return{delayInterval:0,getClients:function(){a.getClientsInterval=l.timer.setInterval(a,function(){if("clients"==c.networkMap.getCurrentModule()&&!t.mapClientsView.clientNameMsg.viewObjs[0].settings.shown&&!(t.mapClientsView.blockConfirmMsg.viewObjs[0].settings.shown||0<a.delayInterval)){a.delayInterval=1;var e={data:{operation:"loadSpeed"},success:function(e){a.delayInterval=0,c.networkMap.trigger("ev_clients_number_changed",i.connectedClientsStore.getData().length)},fail:function(){a.delayInterval=0},error:function(){a.delayInterval=0}};i.blacklistOnlineStore.load(),i.connectedClientsStore.load(e)}},20011,!0)},getAccessControlMode:function(e){var n;e&&(n=e.success),i.blacklistOnlineStore.load(),s.accessControlEnableM.load(),s.accessControl.load({success:function(e){n&&n(s.accessControl.getData())}})},setBlackMode:function(n){"off"==s.accessControlEnableM.enable.getValue()&&s.accessControlEnableM.load({data:{operation:"write",enable:"on"}}),s.accessControl.load({data:{operation:"write",access_mode:"black"},success:function(e){t.mapClientsView.mapClientsAccessControlBtn.setText(o.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST),t.mapClientsView.blockConfirmMsg.setContent(o.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST),n&&n()}})},blockDevice:function(e){function n(){l.ajax.request({data:{operation:"block",data:JSON.stringify([e]),index:i.connectedClientsStore.getIndex(e.key),key:e.key},url:o.su.url("/admin/access_control?form=black_devices"),success:function(){i.blacklistOnlineStore.load({success:function(){i.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){c.networkMap.trigger("ev_clients_number_changed",i.connectedClientsStore.getData().length)}})}})}})}"on"==s.accessControlEnableM.enable.getValue()&&"black"==s.accessControl.accessMode.getValue()?n():a.setBlackMode(n)},beforeDestroy:function(){clearInterval(null)},getIPaddr:function(e){if(deviceStatusData)for(var n in deviceStatusData)for(var t=0,a=deviceStatusData[n].length;t<a;t++)if(deviceStatusData[n][t].macaddr==e)return deviceStatusData[n][t].ipaddr||"";return""},getConnectType:function(e){if(deviceStatusData)for(var n in deviceStatusData)for(var t=0,a=deviceStatusData[n].length;t<a;t++)if(deviceStatusData[n][t].macaddr==e)return n;return""},getSignal:function(e,n){var t=0;l.ajax.request({data:{operation:"read",mac:e,type:"wireless"},proxy:"clientSignalProxy",success:function(e){t=a.convertSignal(e.signal),o("#connected-clients-grid_tr_"+n+" .icon-wireless").addClass("signal-"+t)}})},convertSignal:function(e){var n=1*e+91;return n<=0?0:n<10?1:n<20?2:n<30?3:n<50?4:5},checkDeviceName:function(e){return 0<e.length&&e.length<65&&l.vtype.validate(e,{vtype:"deviceName"})}}})}(jQuery);
!function(o){o.su.moduleManager.define("timeMachine",{services:["ajax"],models:["timeMachine"],stores:["timeMachineStorageList"],views:["timeMachineView"],deps:["main"],listeners:{"ev_on_launch":function(e,a,n,s,i,t,c){var r={data:{},success:function(e,i){var t=parseFloat(parseInt(s.timeMachine.free.getValue())/1073741824).toFixed(1);n.timeMachineView.storageTips.setText(o.su.CHAR.TIME_MACHINE.AVAILABLE_STORAGE.replace("%size%",t)),a.availableSize=t,a.initLocation(e.disk_status)}};s.timeMachine.load(r)},"ev_before_destroy":function(){}},init:function(n,s,c,t,e,i){n.totalSize=0,n.availableSize=0,this.configViews({id:"timeMachineView",items:[{id:"time-machine-storage-list",configs:[{type:"logo",dataIndex:"logo"},{type:"deviceName",dataIndex:"label"},{type:"availableSpace",label:o.su.CHAR.TIME_MACHINE.AVAILABLE_SPACE,dataIndex:"free",renderer:function(e){return e+" "+o.su.CHAR.UNIT.GB}},{type:"totalSpace",label:o.su.CHAR.TIME_MACHINE.TOTAL_SPACE,dataIndex:"capacity",renderer:function(e){return e+" "+o.su.CHAR.UNIT.GB}}]}]}),this.control({"#select-folder":{"ev_button_click":function(){t.timeMachineStorageList.load({data:{operation:"read"},success:function(){0!=t.timeMachineStorageList.getSize()?s.timeMachineView.selectFolderMsg.show():s.timeMachineView.folderEmptyMsg.show()}})}},"#time-machine-storage-list":{"ev_item_click":function(e,i){i&&(c.timeMachine.diskStatus.setValue(0),c.timeMachine.uuid.setValue(i.uuid),c.timeMachine.mntdir.setValue(i.mntdir),c.timeMachine.label.setValue(i.label),s.timeMachineView.storageTips.setText(o.su.CHAR.TIME_MACHINE.AVAILABLE_STORAGE.replace("%size%",i.free)),s.timeMachineView.selectFolderMsg.close(),n.totalSize=Number(i.capacity),n.availableSize=Number(i.free))}},".index-common-save-btn":{"ev_will_auto_save":function(e,i){if(i.preventDefault(),"off"!=c.timeMachine.enable.getValue()){if(1==c.timeMachine.diskStatus.getValue()||2==c.timeMachine.diskStatus.getValue())return!1;if("---"==c.timeMachine.label.getValue())return c.timeMachine.label.setError(o.su.CHAR.TIME_MACHINE.SELECT_HINT),!1;if(0==c.timeMachine.validate())return!1;var a=!1;t.timeMachineStorageList.load({data:{operation:"read"},success:function(e){for(var i=0;i<e.length;i++)c.timeMachine.uuid.getValue()==e[i].uuid&&(a=!0);if(0==a)return c.timeMachine.label.setError(o.su.CHAR.TIME_MACHINE.NOT_AVAILABLE),!1;if(0==c.timeMachine.diskStatus.getValue()){var t=Number(c.timeMachine.limitsize.getValue());if(n.availableSize<t)return s.timeMachineView.storageTips.show(),!1;s.timeMachineView.storageTips.hide()}c.timeMachine.submit({success:function(e){c.timeMachine.loadData(e),s.timeMachineView.storageTips.hide()}})}})}else c.timeMachine.submit({success:function(e){c.timeMachine.loadData(e),s.timeMachineView.storageTips.hide()}})}}}),this.listen({"models.timeMachine.enable":{"ev_value_change":function(e,i,t){"on"==i?(s.timeMachineView.enableBlock.show(),setTimeout(function(){null==t||n.initLocation(c.timeMachine.diskStatus.getValue())},50)):s.timeMachineView.enableBlock.hide()}}})}},function(t,a,i,e,n,s){return(t=this).refreshStatus=!1,{initLocation:function(e){switch(e){case"0":i.timeMachine.label.setNormal();break;case"1":i.timeMachine.label.setError(o.su.CHAR.TIME_MACHINE.SELECT_HINT);break;case"2":i.timeMachine.label.setError(o.su.CHAR.TIME_MACHINE.NOT_AVAILABLE)}},queryTimeMachine:function(){t.stopQuery(),t.refreshStatus=setInterval(function(){s.ajax.request({proxy:"timeMachineProxy",method:"read",success:function(e){var i=parseFloat(parseInt(e.free)/1073741824).toFixed(1);a.timeMachineView.storageTips.setText(o.su.CHAR.TIME_MACHINE.AVAILABLE_STORAGE.replace("%size%",i)),t.availableSize=i,t.initLocation(e.disk_status)},error:function(e){t.stopQuery()},fail:function(e){t.stopQuery()}})},5e3)},stopQuery:function(){clearInterval(t.refreshStatus)}}})}(jQuery);
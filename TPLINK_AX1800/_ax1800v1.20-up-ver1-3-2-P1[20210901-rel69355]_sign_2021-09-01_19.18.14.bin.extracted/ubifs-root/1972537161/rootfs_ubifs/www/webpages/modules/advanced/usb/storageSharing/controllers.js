!function(l){l.su.moduleManager.define("storageSharing",{services:["moduleManager","ajax","device"],models:["fileSharing","accessAddress","accessAuthentication","mediaServer","sharingContents"],stores:["storageStatusStore","storageDeviceStore","ftpEncodingStore","accessAddressStore","secureAddressStore","secureAddressPermissionsStore","treeStore"],views:["storageSharingView"],listeners:{"ev_on_launch":function(e,s,t,a,r,n,i){s.unRegisterAutoSaveData([a.mediaServer,a.accessAuthentication]),a.accessAuthentication.load(),a.accessAddress.load(),a.mediaServer.load(),r.secureAddressStore.load(),r.accessAddressStore.load(),s.storage_proxy_list=["diskListProxy","diskList2Proxy","diskList3Proxy"],this.scanDisk()}},init:function(e,i,o,d,s,c){this.configViews({id:"storageSharingView",items:[{id:"storage-status-group",configs:{nameField:"volumn",fields:[{text:l.su.CHAR.USB_DEVICE.USED,dataIndex:"used",color:"#868484"},{text:l.su.CHAR.USB_DEVICE.AVAILABLE,dataIndex:"free",color:"#4ACBD6"}]}},{id:"storage-device-grid",configs:{columns:[{text:l.su.CHAR.STORAGE_SHARING.DISK,dataIndex:"name",renderer:function(e,s){var t=e.match(/.*\(([^)]*)\)/);if(!t)return e;var a=t[1],r=l.su.numToCapacity(l.su.capacityToNum(a),1);return a&&r?e.replace(a,r):e}},{text:l.su.CHAR.STORAGE_SHARING.PARTITION,dataIndex:"volumn"},{text:l.su.CHAR.STORAGE_SHARING.TOTAL,dataIndex:"free",xtype:"customWidget",cls:"usb-progress-td m-2-row",width:260,renderer:function(e,s){var t=[];return t[0]=100*(1-l.su.capacityToNum(e)/l.su.capacityToNum(s.capacity)),t[1]="<div class='device-usage-info'><span>"+l.su.CHAR.USB_DEVICE.USED+": "+l.su.numToCapacity(l.su.capacityToNum(s.used),1)+"</span>",t[1]+="<span class='device-usage-free'>&nbsp;&nbsp;&nbsp;&nbsp;"+l.su.CHAR.USB_DEVICE.FREE+": "+l.su.numToCapacity(l.su.capacityToNum(e),1)+"</span></div>",t},widgetName:"progressbar",settings:{labelField:null}},{text:l.su.CHAR.GRID.SHARE,dataIndex:"enable",xtype:"customWidget",widgetName:"switch",cls:"eye-switch-td center-td",settings:{labelField:null,trueValue:"on",falseValue:"off"},width:50},{xtype:"actioncolumn",text:l.su.CHAR.PARENTAL_CONTROLS.MODIFY,renderer:function(e,s){return'<span class="icon"></span>','<span class="text"></span>',"</a>",'<a href="javascript:void(0)" class="grid-content-btn grid-content-custom-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'}}]}},{id:"access-address-grid",configs:{columns:[{text:l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD,cls:"l-hide xl-hide",renderer:function(){return""}},{text:l.su.CHAR.COMMON.ENABLE,dataIndex:"enable",cls:"status",width:50,xtype:"customWidget",widgetName:"checkbox",settings:{labelField:null,trueValue:"on",falseValue:"off"}},{text:"",cls:"s-hide m-hide",width:100,renderer:function(){return""}},{text:l.su.CHAR.STORAGE_SHARING.ADDRESS_METHOD,dataIndex:"protocol",renderer:function(e,s){switch(e.toUpperCase()){case"SAMBA":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_SAMBA_WINDOWS;case"FTP":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_LOCAL_FTP;case"FTPEX":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_FTP||l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_SFTP.replace("SFTP","FTP");case"SFTP":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_SFTP}}},{text:l.su.CHAR.STORAGE_SHARING.ADDRESS,dataIndex:"link",cls:"access-address-td",renderer:function(e,s){var t="<div>";t+="<div>"+(null==e?"":e.replace(",","<br />"))+"</div>";var a=c.device.getCurrentDial();return s.edit&&"v6plus"!==a&&"dslite"!==a&&(t+="<div class='access-method-td-jump-container'>",t+="<a class='jump-label address-jump-label' href=\"#ddnsAdv\">"+l.su.CHAR.STORAGE_SHARING.SET_DDNS+"</a>",t+="</div>"),t+="</div>"}},{text:l.su.CHAR.STORAGE_SHARING.PORT,dataIndex:"port",width:50,cls:"center-td access-address-port-td",xtype:"customWidget",renderer:function(e,s){return!s.edit&&e},widgetName:"textbox",settings:{labelField:null}}]}},{id:"secure-address-grid",configs:{popEditor:{editTitle:l.su.CHAR.STORAGE_SHARING.SECURE_ADDRESS_EDIT_TITLE,content:"#secure-address-grid-pop-editor",fields:[{name:"username"},{name:"password"},{name:"permission"},{name:"folder"},{name:"type"}]},columns:[{text:l.su.CHAR.STORAGE_SHARING.USERNAME,dataIndex:"username"},{text:l.su.CHAR.STORAGE_SHARING.PASSWORD,dataIndex:"password",cls:"password-td",xtype:"customWidget",widgetName:"password",settings:{labelField:null,readOnly:!0}},{text:l.su.CHAR.STORAGE_SHARING.PERMISSIONS,dataIndex:"permission",renderer:function(e){return"r"==e?l.su.CHAR.STORAGE_SHARING.READ:"rw"==e?l.su.CHAR.STORAGE_SHARING.READ_AND_WRITE:void 0}},{text:l.su.CHAR.STORAGE_SHARING.MANAGEMENT,xtype:"actioncolumn",cls:"long",renderer:function(e,s){return'<span class="icon"></span>','<span class="text"></span>',"</a>",'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit"><span class="icon"></span><span class="text"></span></a>'}}]}}]}),this.control({"#storage-device-grid":{"ev_grid_tbar_refresh":function(e){this.scanDisk(!0)}},"#storage-device-grid => a.btn-delete":{"ev_grid_action_click":function(e,s){this.removeDisk(d.storageDeviceStore.getModelByKey(s).serial.getValue())}},"#access-address-grid => a.address-jump-label":{"click":function(){o.accessAuthentication.isDirty()||o.accessAddress.isDirty()||d.accessAddressStore.isDirty()?i.storageSharingView.gotoDdnsConfirmMsg.show():setTimeout(function(){c.moduleManager.get("navigatorController").goTo("ddnsAdv")},20)}},"#secure-address-grid => a.grid-content-folder-edit":{"ev_grid_action_click":function(e,s){i.storageSharingView.secureAddressFolderEditMsg.show()}},"#go-to-ddns-confirm-msg":{"ev_msg_ok":function(){setTimeout(function(){c.moduleManager.get("navigatorController").goTo("ddnsAdv")},20)}},"#storage-status-group => .btn-refresh":{"click":function(){this.scanDisk(!0)}},"#scan-device":{"ev_button_click":function(){i.storageSharingView.scanButton.loading(!0),this.scanDisk(!0)}},"#remove-device":{"ev_button_click":function(){this.removeDisk()}}}),this.listen({"stores.storageDeviceStore":{"ev_data_change":function(e,s,t){var a=d.storageDeviceStore.checkDataChange().update;for(var r in a)this.updateDisk(a[r].model.serial,{"operation":"update","index":a[r].index,"key":a[r].model.key,"old":JSON.stringify(a[r].oldModel),"new":JSON.stringify(a[r].model)})}},"models.accessAuthentication.authentication":{"ev_value_change":function(e,s,t){"on"===s?i.storageSharingView.authenticationPanel.show():"off"===s&&i.storageSharingView.authenticationPanel.hide(),o.accessAuthentication.isDirty()&&o.accessAuthentication.submit()}},"models.mediaServer.mediaSharing":{"ev_value_change":function(e,s,t){o.mediaServer.isDirty()&&o.mediaServer.submit()}},"stores.accessAddressStore":{"ev_will_auto_save":function(e,s){s.preventDefault();var t,a={};a.server=o.accessAddress.getData().server,a.enable=[];for(var r=0,n=d.accessAddressStore.getData().length;r<n;r++)if(a.enable.push(d.accessAddressStore.getData()[r].enable),d.accessAddressStore.getData()[r].edit){if(a.port=d.accessAddressStore.getData()[r].port,t=d.accessAddressStore.getSubModelBindByKey(d.accessAddressStore.getData()[r].key).port.getInnerWidget(),!/^\d+$/.test(a.port))return d.accessAddressStore.setMaxRules("","",l.su.CHAR.ERROR["00000042"].replace("80","21")),d.accessAddressStore.showMaxRulesWarning(),t.setError(),!1;var i=parseInt(a.port);if(!(21==i||i<=65535&&1024<=i))return d.accessAddressStore.setMaxRules("","",l.su.CHAR.ERROR["00000042"].replace("80","21")),d.accessAddressStore.showMaxRulesWarning(),t.setError(),!1}a.enable=a.enable.join(),c.ajax.request({proxy:"accessAddressProxy",data:a,success:function(){d.accessAddressStore.load()}})},"ev_loaded":function(){var e=c.device.getCurrentDial(),s=i.storageSharingView.disableInternetFTP;if("v6plus"===e||"dslite"===e){for(var t,a,r=d.accessAddressStore,n=r.getSize();n--;)if("ftpex"===(a=r.getModelByIndex(n)).protocol.getValue()){t=a;break}t?(s.setField("DISALBE_TIP","dslite"===e?l.su.CHAR.NETWORK_INTERNET.DSLITE_CONFLICT_TIPS:l.su.CHAR.NETWORK_INTERNET.V6PLUS_CONFLICT_TIPS),s.show(),t.disableRow(!0)):s.hide()}else s.hide()}},"models.accessAddress":{"ev_will_auto_save":function(e,s){if(s.preventDefault(),o.accessAddress.server.validate()){var t,a={};a.server=o.accessAddress.getData().server,a.enable=[];for(var r=0,n=d.accessAddressStore.getData().length;r<n;r++)if(a.enable.push(d.accessAddressStore.getData()[r].enable),d.accessAddressStore.getData()[r].edit){if(a.port=d.accessAddressStore.getData()[r].port,t=d.accessAddressStore.getSubModelBindByKey(d.accessAddressStore.getData()[r].key).port.getInnerWidget(),!/^\d+$/.test(a.port))return d.accessAddressStore.setMaxRules("","",l.su.CHAR.ERROR["00000042"].replace("80","21")),d.accessAddressStore.showMaxRulesWarning(),t.setError(),!1;var i=parseInt(a.port);if(!(21==i||i<=65535&&1024<=i))return d.accessAddressStore.setMaxRules("","",l.su.CHAR.ERROR["00000042"].replace("80","21")),d.accessAddressStore.showMaxRulesWarning(),t.setError(),!1}a.enable=a.enable.join(),c.ajax.request({proxy:"accessAddressProxy",data:a,success:function(){o.accessAddress.loadData({server:a.server})}})}}}})}},function(i,a,n,o,e,d){i=this;var c=[],s=[],u=[];return{scanDisk:function(e){c=[],u=[],d.ajax.request({url:e?l.su.url("/admin/disk_setting?form=scan"):l.su.url("/admin/disk_setting?form=metadata"),data:{operation:"scan"},preventSuccessEvent:!0,success:function(e){var s=e["number"],r=e.list;if(l("#storage-status-group").hide(),l("#remove-device").hide(),o.storageDeviceStore.hide(),a.storageSharingView.noUSBTips.hide(),a.storageSharingView.scanButton.loading(!1),a.storageSharingView.scanButton.hide(),0==s)return a.storageSharingView.noUSBTips.show(),a.storageSharingView.scanButton.show(),void o.treeStore.loadTreeData([]);o.storageDeviceStore.show(),c=r;for(var t=0,n=0;t<s;t++)!function(a){d.ajax.request({proxy:{extend:"IPFProxy"},url:l.su.url("/admin/disk_setting?form=contents&serial="+r[a].serial),preventSuccessEvent:!0,data:{operation:"load"},ajax:{async:!1},success:function(t){c[a].num=a,u[a]=[],l.each(t,function(e,s){t[e].serial=r[a].serial,t[e].name=r[a].name,u[a].push(n),n++}),c[a].volumnList=t}})}(t);i.renderData()},fail:function(e,s,t){},error:function(){}})},renderData:function(){s=[];for(var e=0;e<c.length;e++)s=s.concat(c[e].volumnList);o.storageDeviceStore.loadData(s),i.renderRow(s),i.renderFolder(s)},renderRow:function(e){o.storageDeviceStore.rowSpan(1,u),o.storageDeviceStore.rowSpan(5,u),o.storageDeviceStore.rowMerge(u)},renderFolder:function(e){for(var s,t=[],a=e.length,r=0;r<a;r++)s=r,d.ajax.request({proxy:{extend:"IPFProxy"},preventSuccessEvent:!0,url:l.su.url("/admin/folder_sharing?form=tree"),data:{operation:"load",path:"",uuid:e[s].uuid},ajax:{async:!1},success:function(e){t.push(e)}});o.treeStore.loadTreeData(t),i.unRegisterAutoSaveData([n.sharingContents]),n.sharingContents.load({success:i.sharingContentsCallback,fail:i.sharingContentsCallback,error:i.sharingContentsCallback})},sharingContentsCallback:function(){i.registerAutoSaveData([n.sharingContents])},removeDisk:function(e){d.ajax.request({url:l.su.url("/admin/disk_setting?form=remove"),data:{operation:"remove",serial:e},success:function(e){i.scanDisk()},fail:function(e,s,t){},error:function(){}})},updateDisk:function(e,s){d.ajax.request({url:l.su.url("/admin/disk_setting?form=contents&serial="+e),data:s,success:function(e){i.scanDisk()},fail:function(e,s,t){},error:function(){}})}}})}(jQuery);
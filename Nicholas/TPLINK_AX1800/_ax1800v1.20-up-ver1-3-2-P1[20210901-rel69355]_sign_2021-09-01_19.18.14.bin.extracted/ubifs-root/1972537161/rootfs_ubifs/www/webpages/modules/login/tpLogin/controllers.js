!function(p){p.su.moduleManager.define("tpLogin",{services:["moduleManager","ajax","moduleLoader"],stores:[],views:["tpLoginView"],deps:["main","utils"],models:["tpLoginModel","tpLoginControl"],listeners:{"ev_on_launch":function(e,o,t,n,i,a,s){s.ajax.request({proxy:"keyProxy",success:function(e){var t=e;t&&t.password&&(o.encryptKey=t.password)}}),t.tpLoginView.adminCheckPanel.hide(),p.su.userInfo={},s.moduleLoader.load({module:"tpLogin",view:"tpLoginView"},{module:"tpCloud",view:"tpCloudView"},t.tpLoginView.tpCloudLoader,function(){var e=s.moduleManager.get("tpCloud");e.setMode("login"),e.goTo("login&page=spfLogin")})}},init:function(e,t,o,n,i,a){this.control({"#login-bind-btn":{"ev_button_click":function(){e.doCloudLogin("bind")}},".tp-login-switch-to-local":{"click":function(){var e=a.moduleManager.get("login");e&&e.goToChildModule("localLogin")}},"#user-conflict-prompt2":{"ev_msg_ok":function(){e.doCloudLogin("login",!0)}}})}},function(i,u,s,e,l,g){i=this;return{encryptKey:"",unLoad:function(){g.moduleLoader.unLoad(u.tpLoginView.tpCloudLoader)},checkAdmin:function(){u.tpLoginView.tpLoginPanel.hide(),p(".tp-login-switch-to-local-container").hide(),u.tpLoginView.adminCheckPanel.show()},doCloudLogin:function(e,t){var o={"operation":e,"token":p.su.userInfo.token},a=g.moduleManager.get("tpCloud");if("bind"==e){if(!s.tpLoginControl.validate())return;s.tpLoginControl.password.getValue();var n=s.tpLoginControl.password.doEncrypt(i.encryptKey);o.password=n}t&&(o.confirm=t),g.ajax.request({proxy:"authProxy",success:function(e){p.su.encryptor.setRSAKey(e.key[0],e.key[1]),p.su.encryptor.setSeq(e.seq),p.su.encryptor.genAESKey(),p.su.encryptor.setHash(p.su.userInfo.token),p.encrypt.encryptManager.recordEncryptor(),g.ajax.request({proxy:"cloudLoginProxy",data:o,isLogin:!0,success:function(e){var t,o,n,i=e.stok||(t="12345",o=top.location.href,0<=(n=o.indexOf("stok="))&&(t=o.substring(n+5)),t);a.postLoginStatus(),p.su.userInfo.role=e.role,p.su.userInfo.cloudLogined=!0,localStorage&&(l.main.setToken(i),localStorage.setItem("userInfo",JSON.stringify(p.su.userInfo)),l.main.reload())},fail:i.loginFailDealer,error:a.postLoginStatus})},fail:a.postLoginStatus,error:a.postLoginStatus})},loginFailDealer:function(e,t){g.moduleManager.get("tpCloud").postLoginStatus(),u.tpLoginView.tpLoginBtn.loading(!1);var o=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&o){var n=String(e.data.errorcode).replace(/^-/,"E");l.main.showNotice(p.su.CHAR.ERROR[n],1,1e4)}else if(t)switch(t){case"user conflict":e.data.logined_user;u.tpLoginView.userConflictMsgContent2.setText(p.su.CHAR.LOGIN.USER_CONFLICT_MSG),u.tpLoginView.userConflictMsg2.show();break;case"login failed":var i=e.data.failureCount,a=(r=e.data.attemptsAllowed)+i;if(0===r){var s=p.su.CHAR.ERROR["00000089"].replace("%num",a);u.tpLoginView.maxAttemptsMsgContent2.setText(s),u.tpLoginView.maxAttemptsMsg2.show()}else if(r<=i){s=(s=p.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",i)).replace("%num2",r),u.tpLoginView.leftAttemptsMsgContent2.setText(s),u.tpLoginView.leftAttemptsMsg2.show()}else u.tpLoginView.leftAttemptsMsgContent2.setText(p.su.CHAR.LOGIN.LOGIN_FAILED),u.tpLoginView.leftAttemptsMsg2.show();break;case"exceeded max attempts":var r;i=e.data.failureCount,a=(r=e.data.attemptsAllowed)+i,s=p.su.CHAR.ERROR["00000089"].replace("%num",a);u.tpLoginView.maxAttemptsMsgContent2.setText(s),u.tpLoginView.maxAttemptsMsg2.show()}}}})}(jQuery);
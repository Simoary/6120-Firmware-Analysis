!function(P){P.su.moduleManager.define("l2tpIpsec",{services:["ajax"],stores:["l2tpIpsecEncryptionStore","l2tpIpsecGridStore","dhcpAddressList"],models:["l2tpIpsecModel","dhcpServer","openVpnModel","pptpVpnModel"],deps:["utils","main"],views:["l2tpIpsecView"],listeners:{"ev_on_launch":function(e,t,p,s,o,l,r){s.l2tpIpsecModel.load(),o.l2tpIpsecGridStore.load(),s.openVpnModel.load(),s.dhcpServer.load(),s.pptpVpnModel.load(),o.dhcpAddressList.load()}},init:function(c,o,I,u,_,e){var l,r;this.configViews({id:"l2tpIpsecView",items:[{id:"grid-l2tp-ipsec",configs:{minLines:0,popEditor:{addTitle:P.su.CHAR.VPN_SERVER_PPTP.ADD_ACCOUNT,editTitle:P.su.CHAR.VPN_SERVER_PPTP.EDIT_ACCOUNT,addBtnText:P.su.CHAR.OPERATION.ADD_UPPERCASE,editBtnText:P.su.CHAR.OPERATION.ADD_UPPERCASE,content:"#grid-l2tp-ipsec-popEditor",fields:[{name:"username"},{name:"password"}]},paging:{},columns:[{text:P.su.CHAR.VPN_SERVER_L2TP_IPSEC.USERNAME,dataIndex:"username"},{text:P.su.CHAR.VPN_SERVER_L2TP_IPSEC.PASSWORD,dataIndex:"password"},{xtype:"actioncolumn",text:P.su.CHAR.VPN_SERVER_L2TP_IPSEC.MODIFY,renderer:function(e,t){return'<span class="icon"></span>','<span class="text"></span>',"</a>",'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete">','<span class="icon"></span>','<span class="text"></span>',"</a>",'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit"><span class="icon"></span><span class="text"></span></a><a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'}}]}}]}),this.listen({"models.l2tpIpsecModel.enable":{"ev_value_change":function(e,t){"on"===t?o.l2tpIpsecView.l2tpIpsecFieldset.show():o.l2tpIpsecView.l2tpIpsecFieldset.hide()}},"models.l2tpIpsecModel.maxconn":{"ev_value_change":function(e,t){I.l2tpIpsecModel.toIpAddr.setTips(P.su.CHAR.VPN_SERVER_L2TP_IPSEC.CLIENT_IP_TIPS.replace("%max%",t))}},"models.l2tpIpsecModel.encrypt":{"ev_value_change":function(e,t){"on"===t?(I.l2tpIpsecModel.ipsecKey.enable(),I.l2tpIpsecModel.ipsecKey.show()):(I.l2tpIpsecModel.ipsecKey.disable(),I.l2tpIpsecModel.ipsecKey.hide())}},"models.l2tpIpsecModel":{"ev_loaded":function(e,t){r=t.enable},"ev_model_submit_complete":function(e,t,p){"success"==t&&(r=p.enable)}}}),this.control({".index-common-save-btn":{"ev_will_auto_save":function(e,t){var p=I.l2tpIpsecModel.fromIpAddr.getValue(),s=I.l2tpIpsecModel.toIpAddr.getValue(),o=I.dhcpServer.ipaddrStart.getValue(),l=(I.dhcpServer.ipaddrEnd.getValue(),u.dhcpAddressList.getData()),r=I.openVpnModel.subnet.getValue(),n=(I.openVpnModel.mask.getValue(),I.pptpVpnModel.fromIpAddr.getValue()),d=(I.pptpVpnModel.toIpAddr.getValue(),u.l2tpIpsecGridStore.getData()),a=I.l2tpIpsecModel.enable.getValue();if(I.l2tpIpsecModel.fromIpAddr.setNormal(),I.l2tpIpsecModel.toIpAddr.setNormal(),!0!==c.validateIpRange())return t.preventDefault(),!1;if(P.su.ipToInt(p)>P.su.ipToInt(s))return I.l2tpIpsecModel.toIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.IP_RANGE),t.preventDefault(),!1;if(10<=P.su.ipToInt(s)-P.su.ipToInt(p))return I.l2tpIpsecModel.toIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.PORT_RANGE_OUT),t.preventDefault(),!1;if(_.utils.isSameNet(p,o,"255.255.255.0"))return I.l2tpIpsecModel.fromIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_DHCP),t.preventDefault(),!1;if(_.utils.isSameNet(s,o,"255.255.255.0"))return I.l2tpIpsecModel.fromIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_DHCP),t.preventDefault(),!1;for(var i=0;i<l.length;i++)if(P.su.ipToInt(l[i].ip)>=P.su.ipToInt(p)&&P.su.ipToInt(l[i].ip)<=P.su.ipToInt(s))return I.l2tpIpsecModel.toIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_RESERVED),t.preventDefault(),!1;return _.utils.isSameNet(p,r,"255.255.255.0")?(I.l2tpIpsecModel.fromIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_OPENVPN),t.preventDefault(),!1):_.utils.isSameNet(s,r,"255.255.255.0")?(I.l2tpIpsecModel.toIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_OPENVPN),t.preventDefault(),!1):_.utils.isSameNet(p,n,"255.255.255.0")?(I.l2tpIpsecModel.fromIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_PPTPVPN),t.preventDefault(),!1):_.utils.isSameNet(s,n,"255.255.255.0")?(I.l2tpIpsecModel.toIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.CONFLICT_WITH_PPTPVPN),t.preventDefault(),!1):0!=d.length||"on"!=a||(_.main.showNotice(P.su.CHAR.VPN_SERVER_L2TP_IPSEC.NO_ACCOUNT_TIP,1),t.preventDefault(),!1)}},"#ipaddr-start":{"ev_textbox_focus":function(){I.l2tpIpsecModel.fromIpAddr.setNormal(),I.l2tpIpsecModel.toIpAddr.setNormal()},"ev_textbox_blur":function(){c.validateIpRange()}},"#ipaddr-end":{"ev_textbox_focus":function(){I.l2tpIpsecModel.fromIpAddr.setNormal(),I.l2tpIpsecModel.toIpAddr.setNormal()},"ev_textbox_blur":function(){c.validateIpRange()}},"#grid-l2tp-ipsec":{"ev_grid_before_item_delete":function(e,t,p){var s=u.l2tpIpsecGridStore.getData();l=p,t.preventDefault(),"on"==r&&1==s.length?o.l2tpIpsecView.deleteAccountAlert.show():o.l2tpIpsecView.deleteAccountConfirm.show()},"ev_grid_before_save":function(e,t){for(var p=u.l2tpIpsecGridStore.getEditingModel(),s=u.l2tpIpsecGridStore.getStoreData(),o=p.username.getValue(),l=p.key.getValue(),r=0;r<s.length;r++)if(o===s[r].username&&l!=s[r].key)return p.username.setError(P.su.CHAR.VPN_SERVER_PPTP.USERNAME_CONFLICT),t.preventDefault(),!1;return!0}},"#delete-account-confirm":{"ev_msg_ok":function(e){u.l2tpIpsecGridStore.getData();u.l2tpIpsecGridStore.removeDataByKey(l),u.l2tpIpsecGridStore.sync()}}})}},function(e,t,p,s,o,l){return{validateIpRange:function(){var e=p.l2tpIpsecModel.fromIpAddr.getValue(),t=p.l2tpIpsecModel.toIpAddr.getValue();return P.su.ipToInt(e)>P.su.ipToInt(t)?(p.l2tpIpsecModel.toIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.IP_RANGE),P.su.CHAR.VPN_SERVER_PPTP.IP_RANGE):!(10<=P.su.ipToInt(t)-P.su.ipToInt(e))||(p.l2tpIpsecModel.toIpAddr.setError(P.su.CHAR.VPN_SERVER_PPTP.PORT_RANGE_OUT),P.su.CHAR.VPN_SERVER_PPTP.PORT_RANGE_OUT)}}})}(jQuery);
!function(c){c.su.moduleManager.define("timeSettings",{models:["timeSettings","language","daylight","time24Model","autoUpgradeModel"],stores:["languageStore","setTimeHourStore","setTimeMinStore","setTimeSecStore","startMonthStore","startWeekStore","startWeekdayStore","startHourStore","setTimeModeStore","timezoneStore"],services:["ajax","language","time","device","moduleManager"],views:["timeSettingsView"],deps:["main"],listeners:{"ev_on_launch":function(e,t,a,n,i,s,o){this.unRegisterAutoSaveData([n.time24Model]),o.time.on("on_time_change",t.onTimeChange),o.time.on("on_hour24_change",t.onHour24Change),i.languageStore.load({success:function(){var e=o.device.getLocale();t.unRegisterAutoSaveData([n.language]),n.language.language.setValue(e),n.language.language.record(),t.registerAutoSaveData([n.language])}}),n.time24Model.load(),n.timeSettings.load(),n.daylight.load(),o.device.getConfig().supportAutoUpdate&&n.autoUpgradeModel.load({success:function(e){t.autoUpdateEnable=e.enable}})},"ev_before_destroy":function(e,t){t.beforeDestroy()}},init:function(u,g,m,e,t,d){this.listen({"models.time24Model":{"ev_loaded":function(e,t){d.time.setHour24("on"===m.time24Model.hour24Enable.getValue())},"ev_model_submit":function(e,t){d.time.setHour24("on"===m.time24Model.hour24Enable.getValue())}},"models.daylight":{"ev_loaded":function(e){"on"===m.daylight.dstEnable.getValue()||m.daylight.dstStatus.getValue()?m.daylight.dstStatus.show():m.daylight.dstStatus.hide(),u.getTimeFormat()}},"models.timeSettings":{"ev_loaded":function(e,t){var a=t.date.split("/");u.sysTimeYear=parseInt(a[2],10),u.sysTimeHash=u.parseFormat(a[0],2)+u.parseFormat(a[1],2)+u.parseFormat(t.time.split(":")[0],2),u.getTimeFormat()}},"models.timeSettings.type":{"ev_value_change":function(e,t,a){"manual"===t?(g.timeSettingsView.manualFieldset.show(),g.timeSettingsView.internetFieldset.hide(),m.timeSettings.time.enable(),m.timeSettings.date.enable()):"auto"===t?(g.timeSettingsView.manualFieldset.hide(),g.timeSettingsView.internetFieldset.show(),m.timeSettings.time.disable(),m.timeSettings.date.disable()):(g.timeSettingsView.manualFieldset.hide(),g.timeSettingsView.internetFieldset.hide(),m.timeSettings.time.enable(),m.timeSettings.date.enable())}},"models.timeSettings.timezone":{"ev_value_change":function(e,t,a){if(null!==a){var n=m.timeSettings.time.getValue().split(":"),i=parseInt(n[0],10),s=parseInt(n[1],10),o=parseInt(60*i,10)+parseInt(s,10)+parseInt(t,10)-parseInt(a,10),r=o%60,l=parseInt(o/60,10),u=24<l?l-24:l;24==u&&0<r&&(u=0),u<0&&(0==u?u=23:u+=24),r<0&&(r+=60),r<10&&(r="0"+r),u<10&&(u="0"+u);var g=u.toString()+":"+r.toString()+":"+n[2];m.timeSettings.time.setValue(g)}}},"models.time24Model.hour24Enable":{"ev_value_change":function(e,t,a){a&&a!==t&&m.time24Model.submit()}},"models.daylight.dstEnable":{"ev_value_change":function(e,t,a){"on"===t?g.timeSettingsView.daylightFieldset.show():g.timeSettingsView.daylightFieldset.hide()}},"models.daylight.startMonth":{"ev_value_change":function(e,t,a){u.getTimeFormat()}},"models.daylight.startWeek":{"ev_value_change":function(e,t,a){u.getTimeFormat()}},"models.daylight.startDay":{"ev_value_change":function(e,t,a){u.getTimeFormat()}},"models.daylight.startHour":{"ev_value_change":function(e,t,a){u.getTimeFormat()}},"models.daylight.endMonth":{"ev_value_change":function(e,t,a){u.getTimeFormat()}},"models.daylight.endWeek":{"ev_value_change":function(e,t,a){u.getTimeFormat()}},"models.daylight.endDay":{"ev_value_change":function(e,t,a){u.getTimeFormat()}},"models.daylight.endHour":{"ev_value_change":function(e,t,a){u.getTimeFormat()}}}),this.control({".index-common-save-btn":{"ev_will_auto_save":function(e,t){t.preventDefault();var a=c.Deferred(),n=c.Deferred();if(m.timeSettings.isDirty()){var i=m.timeSettings.type.getValue();if("pc"===i){var s=new Date,o=function(e){return e<10?"0"+e:e},r=o(s.getMonth()+1)+"/"+o(s.getDate())+"/"+o(s.getFullYear()),l=o(s.getHours())+":"+o(s.getMinutes())+":"+o(s.getSeconds());m.timeSettings.time.setValue(l),m.timeSettings.date.setValue(r),c.when(a).then(function(){d.time.sync()})}else"auto"===i?(g.timeSettingsView.ntpStatus.hide(),c.when(a).then(function(){g.timeSettingsView.ntpStatus.show(),g.timeSettingsView.ntpStatus.setLoading(c.su.CHAR.TIMESETTING.GETGMT_WAIT),m.timeSettings.startGmt({success:function(){u.syncGmt(function(e){d.time.sync(),m.daylight.load()})},fail:function(){g.timeSettingsView.ntpStatus.hide()},error:function(){g.timeSettingsView.ntpStatus.hide()}})})):c.when(a).then(function(){d.time.sync()});m.timeSettings.submit({success:function(){a.resolve()}})}else a.resolve();m.daylight.isDirty()?m.daylight.submit({success:function(){n.resolve()}}):n.resolve(),c.when(a,n).then(function(){m.language.language.isDirty()&&d.language.switchTo(m.language.language.getValue()),m.daylight.load()})}},"#setTimeMode":{"ev_view_change":function(e,t,a){"on"==u.autoUpdateEnable&&"auto"!=a&&("pc"==a?g.timeSettingsView.setTimeCheckMsg.setContent(c.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE1):"manual"==a&&g.timeSettingsView.setTimeCheckMsg.setContent(c.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE2),g.timeSettingsView.setTimeCheckMsg.show())}},"#set-time-check-msg":{"ev_msg_ok":function(e,t){d.moduleManager.get("navigatorController").goTo("firmware")},"ev_msg_no":function(e,t){m.timeSettings.type.setValue("auto")}}})}},function(G,k,x,a,e,i){var n=null;return{autoUpdateEnable:"",sysTimeYear:"2017",sysTimeHash:"",syncGmt:function(e){var t=function(t){i.ajax.request({proxy:"timeSettingsGmtProxy",method:"refresh",success:function(e){if("undefined"==typeof e.status)return k.timeSettingsView.ntpStatus.hide(),clearInterval(n),n=null,!1;switch(parseInt(e.status,10)){case 747301:clearInterval(n),n=null,k.timeSettingsView.ntpStatus.setSuccess(c.su.CHAR.TIMESETTING.GETGMT_SUCCESS),t&&t(e);break;case 747302:clearInterval(n),n=null,k.timeSettingsView.ntpStatus.setFailed(c.su.CHAR.TIMESETTING.GETGMT_TIMEOUT);break;case 747303:k.timeSettingsView.ntpStatus.setLoading(c.su.CHAR.TIMESETTING.GETGMT_WAIT);break;default:clearInterval(n),n=null}}})};clearInterval(n),n=setInterval(function(){t(e)},2e3),t(e)},onTimeChange:function(e,t){var a=i.time.getHour24(),n=i.time.format(t,"yyyy-MM-dd HH:mm:ss",a);k.timeSettingsView.currentTime.setValue(n)},onHour24Change:function(e,t){t?(a.startHourStore.loadData(G.startHour24Data),x.timeSettings.time.setHourSystem("24")):(a.startHourStore.loadData(G.startHourData),x.timeSettings.time.setHourSystem("12"))},clearCurrentTime:function(){clearInterval(n),n=null},beforeDestroy:function(){G.clearCurrentTime(),i.time.off("on_time_change",G.onTimeChange),i.time.off("on_hour24_change",G.onHour24Change)},startHourData:function(){var e,t,a=[];for(e=0;e<=23;e++)a[t=e]={},a[t].value=0===e?(a[t].name="12:00 AM","12am"):e<=11?(a[t].name=e+":00 AM",e+"am"):12===e?(a[t].name="12:00 PM","12pm"):(a[t].name=e-12+":00 PM",e-12+"pm");return a[0].selected=!0,a}(),startHour24Data:function(){var e,t,a=[];for(e=0;e<=23;e++)a[t=e]={},a[t].name=("0"+e).slice(-2)+":00",a[t].value=0===e?"12am":e<=11?e+"am":12===e?"12pm":e-12+"pm";return a[0].selected=!0,a}(),parseFormat:function(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e},getTimeFormat:function(){var e,t,a=G.sysTimeYear,n=G.sysTimeHash,i=x.daylight.startMonth,s=x.daylight.startWeek,o=x.daylight.startDay,r=x.daylight.startHour,l=x.daylight.endMonth,u=x.daylight.endWeek,g=x.daylight.endDay,m=x.daylight.endHour,d=i.getValue(),c=s.getValue(),h=o.getValue(),S=r.getValue(),f=l.getValue(),v=u.getValue(),y=g.getValue(),p=m.getValue();if(!(d&&c&&h&&S&&f&&v&&y&&p))return!1;var T,_,I=parseInt(i.getLiIndex(d))+1,M=parseInt(s.getLiIndex(c))+1,V=parseInt(o.getLiIndex(h))+1,w=parseInt(l.getLiIndex(f))+1,b=parseInt(u.getLiIndex(v))+1,H=parseInt(g.getLiIndex(y))+1;_=-1!==S.indexOf("am")?(T=parseInt(S),parseInt(p)):(T=parseInt(S)+12,parseInt(p)+12);var E=new Date(a,I,1),F=parseInt(E.getDay()),C=new Date(a,w,1),D=parseInt(C.getDay());V=7*M-F+V+1+(V<F?7:0),H=7*b-D+H+1+(H<D?7:0),e=G.parseFormat(I,2)+G.parseFormat(V,2)+G.parseFormat(T,2),t=G.parseFormat(w,2)+G.parseFormat(H,2)+G.parseFormat(_,2);var L=k.timeSettingsView.daylightStart,A=k.timeSettingsView.daylightEnd;e<t?n<t?(L.setSubLabel(a),A.setSubLabel(a)):(L.setSubLabel(a+1),A.setSubLabel(a+1)):n<t?(L.setSubLabel(a-1),A.setSubLabel(a)):(L.setSubLabel(a),A.setSubLabel(a+1))}}})}(jQuery);
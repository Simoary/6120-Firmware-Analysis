!function(d){d.su.moduleManager.define("localLogin",{services:["ajax"],models:["localLogin","localLoginControl","vercodeModel","resetPwdModel"],stores:[],views:["localLoginView"],deps:["login","main"],listeners:{"ev_on_launch":function(e,n,o,i,t,l,r){o.localLoginView.noInternetTips.hide(),r.ajax.request({proxy:"keyProxy",success:function(e){var o=e;o&&o.password&&(n.encryptKey=o.password)}}),l.login.supportCloud()?(o.localLoginView.switchToTp.show(),o.localLoginView.mainPanel.setTitle(d.su.CHAR.LOGIN.LOCAL_LOGIN)):(o.localLoginView.switchToTp.hide(),o.localLoginView.mainPanel.setTitle(d.su.CHAR.LOGIN.LOGIN)),r.ajax.request({proxy:"sysmodeLoginProxy",data:{"operation":"read"},success:function(e){"ap"===e.mode?o.localLoginView.switchToTp.hide():o.localLoginView.switchToTp.show()}})}},init:function(i,t,n,e,o,l){this.control({"#local-login-pwd":{"keyup":function(e){13==e.keyCode&&i.doLogin()}},"#local-login-button":{"ev_button_click":function(){i.doLogin()}},".local-login-switch-to-tp":{"click":function(e){l.ajax.request({proxy:"loginCheckInternetProxy",method:"read",success:function(e){o.login.goToChildModule("tpLogin")},fail:function(){t.localLoginView.noInternetTips.show(),t.localLoginView.noInternetTips.setText(d.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)},error:function(){t.localLoginView.noInternetTips.show(),t.localLoginView.noInternetTips.setText(d.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)}})}},".local-login-forget-pwd":{"mousedown":function(){i.forgetPasswordHandler()}},"#send-code-btn":{"ev_button_click":function(){t.localLoginView.sendCodeFailedNote.hide(),l.ajax.request({data:{operation:"read"},proxy:"sendCodeProxy",success:function(e){i.enableConfirm=!0,t.localLoginView.sendCodeBtn.disable(),t.localLoginView.sendCodeBtn.setText(i.receiveCodeTimeCount+d.su.CHAR.LOGIN.SEC),clearInterval(i.countDownTimer),i.countDownTimer=setInterval(function(){0<i.receiveCodeTimeCount?(i.receiveCodeTimeCount--,t.localLoginView.sendCodeBtn.setText(i.receiveCodeTimeCount+d.su.CHAR.LOGIN.SEC)):(clearInterval(i.countDownTimer),i.receiveCodeTimeCount=60,t.localLoginView.sendCodeBtn.enable(),t.localLoginView.sendCodeBtn.setText(d.su.CHAR.LOGIN.SEND))},1e3)},fail:function(){t.localLoginView.sendCodeFailedNote.show()}})}},"#confirm-code-btn":{"ev_button_click":function(){i.enableConfirm&&(t.localLoginView.sendCodeFailedNote.hide(),n.vercodeModel.submit({success:function(e){i.vercode=e.vercode,t.localLoginView.forgetPasswordSendCodeMsg.hide(),n.resetPwdModel.password.setValue(),n.resetPwdModel.confirm.setValue(),t.localLoginView.resetPasswordMsg.show()},fail:function(e,o){n.vercodeModel.vercode.setError(),t.localLoginView.confirmCodeOverlimitNote.setText(d.su.CHAR.ERROR[o]),t.localLoginView.confirmCodeOverlimitMsg.show()},error:function(){n.vercodeModel.vercode.setError()}}))}},"#reset-pwd-btn":{"ev_button_click":function(){if(n.resetPwdModel.validate()){if(n.resetPwdModel.password.getValue()!=n.resetPwdModel.confirm.getValue())return void n.resetPwdModel.confirm.setError(d.su.CHAR.ERROR["00000080"]);var e=n.resetPwdModel.password.doEncrypt(i.encryptKey);l.ajax.request({proxy:"forgetPasswordProxy",data:{operation:"write",password:e,confirm:!0,vercode:i.vercode},success:function(e){t.localLoginView.resetPasswordMsg.hide()}})}}},"#send-code-content":{"ev_view_change":function(e,o){if("value"===o.type){var n=o.value;i.enableConfirm&&n?t.localLoginView.confirmCodeBtn.enable():t.localLoginView.confirmCodeBtn.disable()}}},".find-local-pwd-jump-label":{"click":function(){i.queryRecoveryPasswordMethod().then(function(e){e?o.login.goToChildModule("localPwdRecovery"):t.localLoginView.noRecoveryMethodMsg.show()})}},"#user-conflict-prompt":{"ev_msg_ok":function(){var e=n.localLoginControl.password.doEncrypt(i.encryptKey);n.localLogin.password.setValue(e),n.localLogin.login({data:{operation:"login",confirm:!0},success:i.loginSuccessDealer,fail:i.loginFailDealer,error:i.loginErrorDealer})}}})}},function(n,s,c,e,r,i){return{enableConfirm:!1,receiveCodeTimeCount:60,countDownTimer:null,encryptKey:null,vercode:"",doLogin:function(){if(c.localLoginControl.validate()){var o=c.localLoginControl.password.getValue(),e=c.localLoginControl.password.doEncrypt(n.encryptKey);c.localLogin.password.setValue(e),s.localLoginView.localLoginBtn.loading(!0),i.ajax.request({proxy:"authProxy",success:function(e){d.su.encryptor.setRSAKey(e.key[0],e.key[1]),d.su.encryptor.setSeq(e.seq),d.su.encryptor.genAESKey(),d.su.encryptor.setHash("admin",o),d.encrypt.encryptManager.recordEncryptor(),c.localLogin.login({preventFailEvent:!0,success:n.loginSuccessDealer,fail:n.loginFailDealer,error:n.loginErrorDealer})},error:n.loginErrorDealer})}},loginSuccessDealer:function(e,o){s.localLoginView.localLoginBtn.loading(!1);var n,i,t,l=e.stok||(n="12345",i=top.location.href,0<=(t=i.indexOf("stok="))&&(n=i.substring(t+5)),n);localStorage&&(r.main.setToken(l),r.main.reload())},loginFailDealer:function(e,o){s.localLoginView.localLoginBtn.loading(!1);var n=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&n){var i=String(e.data.errorcode).replace(/^-/,"E");c.localLoginControl.password.setErrorHtml(d.su.CHAR.ERROR[i])}else if(o)switch(o){case"user conflict":e.data.logined_user;s.localLoginView.userConflictMsgContent.setText(d.su.CHAR.LOGIN.USER_CONFLICT_MSG),s.localLoginView.userConflictMsg.show();break;case"login failed":var t=e.data.failureCount,l=(a=e.data.attemptsAllowed)+t;if(0===a){var r=d.su.CHAR.ERROR["00000089"].replace("%num",l);s.localLoginView.maxAttemptsMsgContent.setText(r),s.localLoginView.maxAttemptsMsg.show()}else if(a<=t){r=(r=d.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",t)).replace("%num2",a),s.localLoginView.leftAttemptsMsgContent.setText(r),s.localLoginView.leftAttemptsMsg.show()}else s.localLoginView.leftAttemptsMsgContent.setText(d.su.CHAR.LOGIN.LOGIN_FAILED),s.localLoginView.leftAttemptsMsg.show();break;case"exceeded max attempts":var a;t=e.data.failureCount,l=(a=e.data.attemptsAllowed)+t,r=d.su.CHAR.ERROR["00000089"].replace("%num",l);s.localLoginView.maxAttemptsMsgContent.setText(r),s.localLoginView.maxAttemptsMsg.show()}},loginErrorDealer:function(){r.main.reload()},queryRecoveryPasswordMethod:function(){var e=d.Deferred();return e.resolve(!0),e.promise()},forgetPasswordHandler:function(){i.ajax.request({proxy:"forgetPasswordProxy",success:function(e){e&&(e.enable_rec?(s.localLoginView.sendCodeFailedNote.hide(),c.vercodeModel.vercode.setNormal(),c.vercodeModel.vercode.setValue(),s.localLoginView.confirmCodeBtn.disable(),s.localLoginView.forgetPasswordSendCodeMsg.show()):s.localLoginView.forgetPasswordMsg.show(),clearInterval(n.countDownTimer),n.receiveCodeTimeCount=60,s.localLoginView.sendCodeBtn.enable(),s.localLoginView.sendCodeBtn.setText(d.su.CHAR.LOGIN.SEND))}})}}})}(jQuery);
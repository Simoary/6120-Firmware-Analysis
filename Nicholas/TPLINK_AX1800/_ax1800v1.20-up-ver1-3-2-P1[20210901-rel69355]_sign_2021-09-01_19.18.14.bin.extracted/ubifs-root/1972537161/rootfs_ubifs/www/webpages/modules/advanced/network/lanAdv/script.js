jQuery.su.moduleManager.define("lanAdv",{services:["moduleLoader","moduleManager","ajax","device"],models:["lanAdvLanModel","lanAdvLinkAggModel"],deps:["main"],views:["lanAdvView"],listeners:{ev_on_launch:function(e,n,a,l,o,t,d){this.hasLinkAgg()&&d.moduleLoader.load({module:"lanAdv"},{module:"lanAdvLinkAgg"},a.lanAdvView.lanAdvLinkAggLoader),this.hasLan()&&d.moduleLoader.load({module:"lanAdv"},{module:"lanAdvLan"},a.lanAdvView.lanAdvLanLoader)}},init:function(e,v,A,n,l,m){this.configViews({id:"lanAdvView",items:[{id:"lan-adv-link-agg-loader"},{id:"lan-adv-lan-loader"}]}),this.control({".index-common-save-btn":{"ev_will_auto_save":function(e,n){n.preventDefault();var a=0,l=A.lanAdvLinkAggModel.enableAgg.getValue(),o=A.lanAdvLinkAggModel.ports.getValue();for(var t in o)o[t]&&a++;var d=A.lanAdvLanModel.isDirty(),i=A.lanAdvLinkAggModel.isDirty(),s=A.lanAdvLanModel.ipaddr.isDirty(),r=m.moduleManager.get("lanAdvLan");if(A.lanAdvLanModel.validate())if("1"==l&&a<2)v.lanAdvView.lanSelectTwoMsg.show();else if(!d&&i){if(m.device.getConfig().supportLanAggCfg)return void A.lanAdvLinkAggModel.submit();v.lanAdvView.lanAdvRebootMsg.show()}else if(d&&!i){if(r.lanValidate())if(s)v.lanAdvView.lanIpChangeMsg.show();else{var u=this;v.lanAdvView.lanAdvRebootAnimate.show(),A.lanAdvLanModel.submit({success:function(){setTimeout(function(){v.lanAdvView.lanAdvRebootAnimate.close(function(){u.goToNewUrl()})},4e4)},fail:function(){v.lanAdvView.lanAdvRebootAnimate.close()},error:function(){v.lanAdvView.lanAdvRebootAnimate.close()}})}}else r.lanValidate()&&v.lanAdvView.lanAdvIPRebootMsg.show()}},"#lan-ip-change .btn-msg-ok":{"ev_button_click":function(){var e=this;A.lanAdvLinkAggModel.enableAgg.getValue(),v.lanAdvView.lanAdvRebootAnimate.show(),A.lanAdvLanModel.submit({success:function(){setTimeout(function(){v.lanAdvView.lanAdvRebootAnimate.close(function(){e.goToNewUrl()})},4e4)},fail:function(){v.lanAdvView.lanAdvRebootAnimate.close()},error:function(){v.lanAdvView.lanAdvRebootAnimate.close()}})}},"#lan-reboot .btn-msg-ok":{"ev_button_click":function(){A.lanAdvLinkAggModel.submit({success:function(){m.ajax.request({proxy:"rebootProxy",success:function(e){var n=e.rebootTime?1e3*e.rebootTime:75e3;l.main.startReboot(n)}})}})}},"#lan-IPreboot .btn-msg-ok":{"ev_button_click":function(){var a=this;A.lanAdvLinkAggModel.submit(),A.lanAdvLanModel.submit({success:function(){m.ajax.request({proxy:"rebootProxy",success:function(e){var n=e.rebootTime?1e3*e.rebootTime:75e3;l.main.startReboot(n,function(){a.goToNewUrl()})}})}})}}})}},function(e,n,a,l,o,t){return{hasLinkAgg:function(){return t.device.getLanAgg()},hasLan:function(){return!0},goToNewUrl:function(e){location.href="http://tplinkwifi.net"}}}),function(s){s.su.moduleManager.define("lanAdvLan",{services:[],deps:["utils"],models:["lanAdvLanModel","lanAdvWanModel"],stores:["lanAdvSubnetCombo"],views:["lanAdvLanView"],listeners:{ev_on_launch:function(e,a,n,l,o,t,d){l.lanAdvLanModel.load({success:function(){a.ipValOrigin=l.lanAdvLanModel.ipaddr.getValue()}}),l.lanAdvWanModel.load({success:function(){a.wanIP=l.lanAdvWanModel.wanIpv4Ipaddr.getValue(),a.wanMask=l.lanAdvWanModel.wanIpv4Netmask.getValue(),a.connType=l.lanAdvWanModel.wanIpv4Conntype.getValue();var e=l.lanAdvWanModel.wanIpv4SndIpaddr.getValue(),n=l.lanAdvWanModel.wanIpv4SndNetmask.getValue();a.wanSndIP=null!==e&&e!==undefined?e:0,a.wanSndMask=null!==n&&n!==undefined?n:0}})}},init:function(e,n,l,a,o,t){this.listen({"models.lanAdvLanModel.maskType":{"ev_value_change":function(e,n,a){3===n?(l.lanAdvLanModel.customValue.show(),l.lanAdvLanModel.customValue.enable()):(l.lanAdvLanModel.customValue.hide(),l.lanAdvLanModel.customValue.disable())}}}),this.control()}},function(o,e,t,d,i,n){return{lanValidate:function(){var e=t.lanAdvLanModel.ipaddr.getValue(),n=t.lanAdvLanModel.maskType.getValue();maskStr=3===n?t.lanAdvLanModel.customValue.getValue():d.lanAdvSubnetCombo.getData()[n].name;var a=i.utils.isSameNet(o.wanIP,e,o.wanMask),l=i.utils.isSameNet(e,o.wanIP,maskStr);return a||l?(t.lanAdvLanModel.ipaddr.setError(s.su.CHAR.ERROR["00000060"]),!1):!i.utils.isNetIpLegal(e,maskStr)||i.utils.isNetIp(e,maskStr)||i.utils.isBroadCastIp(e,maskStr)?(t.lanAdvLanModel.ipaddr.setError(s.su.CHAR.ERROR["00000059"]),!1):"l2tp"!=o.connType&&"pptp"!=o.connType&&"pppoe"!=o.connType||0==o.wanSndIP||0==o.wanSndMask||!i.utils.isSameNet(e,o.wanSndIP,o.wanSndMask)&&!i.utils.isSameNet(o.wanSndIP,e,maskStr)||(t.lanAdvLanModel.ipaddr.setError(s.su.CHAR.ERROR["00000060"]),!1)}}})}(jQuery),function(e){e.su.modelManager.define("lanAdvLanModel",{type:"model",fields:[{name:"macaddr"},{name:"ipaddr",vtype:"ip",allowBlank:!1},{name:"maskType",mapping:"mask_type"},{name:"customValue",mapping:"custom_value",allowBlank:!1,vtype:"netmask",defaultValue:"255.255.255.0"}],convert:function(e){var n={};switch(n.macaddr=e.macaddr,n.ipaddr=e.ipaddr,e.mask_type){case"255.255.255.0":n.mask_type=0;break;case"255.255.0.0":n.mask_type=1;break;case"255.0.0.0":n.mask_type=2;break;default:n.mask_type=3}return n.custom_value=e.custom_value,n.lan_type=e.lan_type,n},serialize:function(e){var n={};switch(n.macaddr=e.macaddr,n.ipaddr=e.ipaddr,e.mask_type){case 0:n.mask_type="255.255.255.0";break;case 1:n.mask_type="255.255.0.0";break;case 2:n.mask_type="255.0.0.0";break;default:n.mask_type="custom"}return n.custom_value=e.custom_value,n.lan_type=e.lan_type,n},proxy:{url:e.su.url("/admin/network?form=lan_ipv4")}}),e.su.modelManager.define("lanAdvWanModel",{type:"model",fields:[{name:"wanIpv4Ipaddr",mapping:"wan_ipv4_ipaddr"},{name:"wanMacaddr",mapping:"wan_macaddr"},{name:"wanIpv4Netmask",mapping:"wan_ipv4_netmask"},{name:"wanIpv4Gateway",mapping:"wan_ipv4_gateway"},{name:"wanIpv4Pridns",mapping:"wan_ipv4_pridns"},{name:"wanIpv4Snddns",mapping:"wan_ipv4_snddns"},{name:"wanIpv4Conntype",mapping:"wan_ipv4_conntype"},{name:"lanIpv4Ipaddr",mapping:"lan_ipv4_ipaddr"},{name:"lanIpv4Netmask",mapping:"lan_ipv4_netmask"},{name:"lanMacaddr",mapping:"lan_macaddr"},{name:"lanIpv4DhcpEnable",mapping:"lan_ipv4_dhcp_enable"},{name:"wanIpv4SndIpaddr",mapping:"wan_ipv4_snd_ipaddr"},{name:"wanIpv4SndNetmask",mapping:"wan_ipv4_snd_netmask"}],proxy:{url:e.su.url("/admin/network?form=status_ipv4")}}),e.su.storeManager.define("lanAdvSubnetCombo",{type:"store",fields:[{name:"name"},{name:"value"},{name:"boxlabel"}],data:[{name:"255.255.255.0",value:0,boxlabel:"255.255.255.0"},{name:"255.255.0.0",value:1,boxlabel:"255.255.0.0"},{name:"255.0.0.0",value:2,boxlabel:"255.0.0.0"},{name:e.su.CHAR.NETWORK_LAN.CUSTOM,value:3,boxlabel:"custom"}]})}(jQuery),function(v){v.su.moduleManager.define("lanAdvLinkAgg",{services:["device"],models:["lanAdvLinkAggModel","iptvVlan"],stores:["lanAdvLinkModeCombo","lanAdvLinkPortsStore","lanAdvHashModeCombo","iptvVlanStore"],views:["lanAdvLinkAggView"],listeners:{ev_on_launch:function(e,l,o,t,n,a,d){l.isConfigurable()&&(o.lanAdvLinkAggView.lanAdvLinkAggPanel.setInstruction(v.su.CHAR.NETWORK_LAN.LINK_CONFIG_INSTRUCTION),o.lanAdvLinkAggView.lanAdvLinkAggContent.show(),o.lanAdvLinkAggView.lanAdvLinkAggContent.enable()),t.lanAdvLinkAggModel.enableAgg.enable(),t.lanAdvLinkAggModel.load({success:function(){var e=t.iptvVlan.enable.getValue(),n=d.device.getLanIptv();if("on"==e&&!n){t.lanAdvLinkAggModel.enableAgg.disable();var a=v.su.CHAR.NETWORK_LAN.LAN_DISABLE_TIPS.replace("%function%",'<a href="#iptvAdv">'+v.su.CHAR.NETWORK_LAN.IPTV+"</a>");t.lanAdvLinkAggModel.enableAgg.setTips(a),l.isConfigurable()&&o.lanAdvLinkAggView.lanAdvLinkAggContent.hide()}}})}},init:function(d,i,s,e,n,a){this.configViews({id:"lanAdvLinkAggView",items:[{id:"lan-adv-link-agg-content"}]});var r,u=[];s.iptvVlan.load({success:function(e){r="on"==e.enable&&!a.device.getLanIptv(),u[0]="Internet"!=e.lan1&&r?1:0,u[1]="Internet"!=e.lan2&&r?1:0,u[2]="Internet"!=e.lan3&&r?1:0,u[3]="Internet"!=e.lan4&&r?1:0}}),this.control(),this.listen({"models.lanAdvLinkAggModel.enableAgg":{"ev_value_change":function(e,n,a){if(d.isConfigurable())if("0"==n)i.lanAdvLinkAggView.lanAdvLinkAggContent.hide();else{i.lanAdvLinkAggView.lanAdvLinkAggContent.show();for(var l=0,o=0;o<u.length;o++)0!=u[o]&&"on"==r&&(s.lanAdvLinkAggModel.ports.disableItem(o),l++);if(2<l){var t=v.su.CHAR.NETWORK_LAN.LAN_ADVPORTS_TIPS_1+'<a href="#iptvAdv">'+v.su.CHAR.NETWORK_LAN.IPTV+"</a>"+v.su.CHAR.NETWORK_LAN.LAN_ADVPORTS_TIPS_2;s.lanAdvLinkAggModel.ports.setTips(t)}}}},"models.lanAdvLinkAggModel.ports":{"ev_value_change":function(e,n,a){for(var l=4,o=0,t=[],d=0;d<4;d++)0!=u[d]&&"on"==r&&l--;l<2?s.lanAdvLinkAggModel.ports.setTips(v.su.CHAR.NETWORK_LAN.LA_PORTS_TIPS):s.lanAdvLinkAggModel.ports.setTips("");var i=s.lanAdvLinkAggModel.ports.getValue();for(d=0;d<4;d++)i["lan"+(d+1)]?(o++,t[d]=1):t[d]=0;if(2<=o)for(d=0;d<4;d++)t[d]||s.lanAdvLinkAggModel.ports.disableItem(d);else for(d=0;d<4;d++)0!=u[d]&&"on"==r||s.lanAdvLinkAggModel.ports.enableItem(d)}}})}},function(e,n,a,l,o,t){return{isConfigurable:function(){return!!t.device.getConfig().supportLanAggCfg}}})}(jQuery),function(n){n.su.modelManager.define("lanAdvLinkAggModel",{preventSuccessEvent:!0,type:"model",fields:[{name:"enableAgg",mapping:"enable_agg",defaultValue:"0"},{name:"lacpmode"},{name:"hashmode"},{name:"ports"},{name:"LAN1"},{name:"LAN2"},{name:"LAN3"},{name:"LAN4"}],convert:function(e){var n={};return n.enable_agg=e.enable_agg,n.lacpmode=e.lacpmode,n.hashmode=e.hashmode,n.ports={"lan1":"1"==e.LAN1,"lan2":"1"==e.LAN2,"lan3":"1"==e.LAN3,"lan4":"1"==e.LAN4},n},serialize:function(e){var n={};return n.enable_agg=e.enable_agg,n.lacpmode=e.lacpmode,n.hashmode=e.hashmode,n["LAN1"]=e.ports.lan1?"1":"0",n["LAN2"]=e.ports.lan2?"1":"0",n["LAN3"]=e.ports.lan3?"1":"0",n["LAN4"]=e.ports.lan4?"1":"0",n},proxy:{url:n.su.url("/admin/network?form=lan_agg")}}),n.su.storeManager.define("lanAdvLinkModeCombo",{type:"store",fields:[{name:"name"},{name:"value"},{name:"boxlabel"}],data:[{name:n.su.CHAR.NETWORK_LAN.Static_LAG,value:0,boxlabel:"Static LAG"},{name:n.su.CHAR.NETWORK_LAN.LACP,value:1,boxlabel:"LACP"}]}),n.su.storeManager.define("lanAdvHashModeCombo",{type:"store",fields:[{name:"name"},{name:"value"},{name:"boxlabel"}],data:[{name:n.su.CHAR.NETWORK_LAN.SRC_DST,value:0,boxlabel:"SRC_DST"},{name:n.su.CHAR.NETWORK_LAN.SRC,value:1,boxlabel:"SRC"},{name:n.su.CHAR.NETWORK_LAN.DST,value:2,boxlabel:"DST"}]}),n.su.storeManager.define("lanAdvLinkPortsStore",{type:"store",fields:[{name:"name"},{name:"value"},{name:"boxlabel"}],data:[{name:"lan1",value:0,boxlabel:"LAN1"},{name:"lan2",value:1,boxlabel:"LAN2"},{name:"lan3",value:2,boxlabel:"LAN3"},{name:"lan4",value:3,boxlabel:"LAN4"}],proxy:null}),n.su.define("rebootProxy",{extend:"IPFProxy",url:n.su.url("/admin/system?form=reboot"),preventSuccessEvent:!0,writeFilter:function(e){return n.extend({operation:"write"},e)},readFilter:function(e){return{rebootTime:(e=e.data).reboot_time}}})}(jQuery);